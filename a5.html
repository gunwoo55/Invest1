<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 캐시 무력화 메타태그 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-buster" content="v2.4.0-20250108151511">
    
    <title>FINE U - 등급 메뉴 (모의투자)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css?v=2.4.0-20250108151511" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css?v=2.4.0-20250108151511">
    <script src="https://cdn.jsdelivr.net/npm/chart.js?v=2.4.0-20250108151511"></script>
    
    <!-- 전역 레벨 관리 시스템 -->
    <script src="js/levelManager.js?v=2.4.0-20250108151511"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            zoom: 1;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        .card-shadow {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4A6FA5, #6B8DC7);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 111, 165, 0.3);
        }
        
        .level-yellow { background: linear-gradient(135deg, #FCD34D, #F59E0B); }
        .level-orange { background: linear-gradient(135deg, #FB923C, #EA580C); }
        .level-green { background: linear-gradient(135deg, #34D399, #059669); }
        .level-blue { background: linear-gradient(135deg, #60A5FA, #2563EB); }
        .level-brown { background: linear-gradient(135deg, #A16207, #92400E); }
        .level-black { background: linear-gradient(135deg, #374151, #111827); }
        .level-red { background: linear-gradient(135deg, #EF4444, #DC2626); }
        
        .asset-item {
            transition: all 0.3s ease;
        }
        
        .asset-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .asset-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .asset-item.locked:hover {
            transform: none;
            box-shadow: none;
        }
        
        .expense-item {
            border-left: 4px solid #EF4444;
        }
        
        .income-item {
            border-left: 4px solid #10B981;
        }
        
        .chart-container {
            position: relative;
            height: 200px;
        }
        
        .portfolio-chart {
            height: 150px;
        }
        
        .investment-section {
            display: none;
        }
        
        .investment-section.active {
            display: block;
        }
        
        .price-positive {
            color: #10B981;
        }
        
        .price-negative {
            color: #EF4444;
        }
        
        .investment-item {
            transition: all 0.3s ease;
        }
        
        .investment-item:hover {
            background-color: #F9FAFB;
        }
        
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #3498db;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .price-update {
            transition: all 0.3s ease;
        }
        
        .price-flash-green {
            background-color: #10B981 !important;
            color: white !important;
        }
        
        .price-flash-red {
            background-color: #EF4444 !important;
            color: white !important;
        }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .level-progress {
            transition: width 0.5s ease;
        }
        
        @keyframes bounce {
            0%, 20%, 60%, 100% {
                transform: translate(-50%, -50%) translateY(0);
            }
            40% {
                transform: translate(-50%, -50%) translateY(-30px);
            }
            80% {
                transform: translate(-50%, -50%) translateY(-15px);
            }
        }
        
        .price-trend-up {
            color: #10B981;
            font-weight: 600;
        }
        
        .price-trend-down {
            color: #EF4444;
            font-weight: 600;
        }
        
        .investment-card {
            transition: all 0.2s ease;
        }
        
        .investment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* V4 Badge Styles - Enhanced design with improved compactness and cache busting */
        .level-badge-profile-v4 {
            display: inline-block !important;
            padding: 4px 8px !important; /* Ultra-compact design */
            border-radius: 6px !important; /* Perfect text fitting */
            font-size: 12px !important;
            font-weight: 700 !important;
            color: white !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7) !important;
            position: relative !important;
            overflow: hidden !important;
            letter-spacing: 0.3px !important; /* Minimal spacing */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 
                0 3px 12px rgba(0,0,0,0.2) !important, 
                inset 0 1px 0 rgba(255,255,255,0.4) !important,
                inset 0 -1px 0 rgba(0,0,0,0.25) !important;
            border: 1px solid rgba(255,255,255,0.3) !important;
            text-align: center !important;
            backdrop-filter: blur(2px) !important;
            line-height: 1.2 !important;
            white-space: nowrap !important;
        }

        .level-badge-nav-v4 {
            width: 54px !important; /* Optimized proportions */
            height: 54px !important; /* Balanced design */
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: 800 !important;
            color: white !important;
            font-size: 9px !important;
            text-shadow: 0 2px 6px rgba(0,0,0,0.8) !important;
            position: absolute !important;
            top: -6px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.3) !important, 
                0 4px 8px rgba(0,0,0,0.2) !important, 
                inset 0 3px 0 rgba(255,255,255,0.4) !important, 
                inset 0 -3px 0 rgba(0,0,0,0.25) !important,
                0 0 0 2px rgba(255,255,255,0.1) !important;
            z-index: 10 !important;
            cursor: pointer !important;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            border: 2px solid rgba(255,255,255,0.3) !important;
            position: relative !important;
            overflow: hidden !important;
            letter-spacing: 0.2px !important;
            backdrop-filter: blur(6px) !important; /* Premium effect */
        }

        .level-badge-profile-v4:hover {
            transform: translateY(-1px) scale(1.03) !important;
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.25) !important, 
                inset 0 1px 0 rgba(255,255,255,0.5) !important,
                inset 0 -1px 0 rgba(0,0,0,0.3) !important;
        }

        .level-badge-nav-v4:hover {
            transform: translateX(-50%) scale(1.08) rotate(3deg) !important;
            box-shadow: 
                0 12px 35px rgba(0,0,0,0.35) !important, 
                0 6px 15px rgba(0,0,0,0.25) !important, 
                inset 0 3px 0 rgba(255,255,255,0.5) !important, 
                inset 0 -3px 0 rgba(0,0,0,0.35) !important,
                0 0 0 3px rgba(255,255,255,0.15) !important,
                0 0 20px rgba(255,255,255,0.3) !important;
        }

        .level-badge-nav-v4:active {
            transform: translateX(-50%) scale(0.96) !important;
        }
    </style>
</head>
<body>

<div class="min-h-screen bg-gray-100">
    <!-- 상단 헤더 -->
    <div class="bg-white shadow-sm p-4">
        <div class="flex items-center justify-between max-w-md mx-auto">
            <button onclick="goToIndex()" class="text-gray-600">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <h1 class="text-xl font-bold">등급 메뉴</h1>
            <button onclick="showPortfolioModal()" class="text-blue-600">
                <i class="fas fa-chart-pie text-xl"></i>
            </button>
        </div>
    </div>

    <div class="max-w-md mx-auto px-4 py-6">
        <!-- 현재 등급 표시 -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-6">
            <div class="text-center mb-4">
                <div id="currentLevelBadge" class="level-badge-profile-v4 inline-block px-6 py-3 rounded-full text-white font-bold text-lg" style="padding: 4px 8px !important; border-radius: 6px !important;">
                    BRONZE
                </div>
                <p class="text-gray-600 mt-2">현재 등급</p>
            </div>
            <div class="bg-gray-100 rounded-lg p-3 mb-3">
                <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>경험치</span>
                    <span id="userExp">0 / 3000 EXP</span>
                </div>
                <div class="bg-gray-300 rounded-full h-2">
                    <div id="expBar" class="bg-blue-500 rounded-full h-2 exp-bar" style="width: 0%"></div>
                </div>
            </div>
            <!-- 가상 자산 표시 -->
            <div class="bg-blue-50 rounded-lg p-3">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">가상 자산</span>
                    <span class="font-bold text-blue-600" id="virtualBalance">1,000,000원</span>
                </div>
            </div>
        </div>

        <!-- 가계부 섹션 -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-wallet text-blue-500 mr-2"></i>가계부
            </h2>
            
            <!-- 이번 달 요약 -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <i class="fas fa-arrow-up text-green-500 text-xl mb-2"></i>
                    <p class="text-sm text-gray-600">수입</p>
                    <p class="text-lg font-bold text-green-600" id="totalIncome">0원</p>
                </div>
                <div class="bg-red-50 rounded-lg p-4 text-center">
                    <i class="fas fa-arrow-down text-red-500 text-xl mb-2"></i>
                    <p class="text-sm text-gray-600">지출</p>
                    <p class="text-lg font-bold text-red-600" id="totalExpense">0원</p>
                </div>
            </div>
            
            <!-- 가계부 차트 -->
            <div class="chart-container mb-4">
                <div id="budgetChartLoading" class="text-center py-8">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="text-gray-500 mt-2">차트 로딩 중...</p>
                </div>
                <canvas id="budgetChart" style="display: none;"></canvas>
            </div>
            
            <!-- 가계부 관리 버튼 -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <button onclick="showAddIncomeModal()" class="bg-green-500 text-white py-2 rounded-lg text-sm">
                    <i class="fas fa-plus mr-1"></i>수입
                </button>
                <button onclick="showAddExpenseModal()" class="bg-red-500 text-white py-2 rounded-lg text-sm">
                    <i class="fas fa-minus mr-1"></i>지출
                </button>
                <button onclick="showFilterModal()" class="bg-blue-500 text-white py-2 rounded-lg text-sm">
                    <i class="fas fa-filter mr-1"></i>필터
                </button>
                <button onclick="showTransactionHistory()" class="bg-purple-500 text-white py-2 rounded-lg text-sm">
                    <i class="fas fa-history mr-1"></i>전체
                </button>
            </div>
            
            <!-- 최근 내역 -->
            <div>
                <h3 class="font-semibold mb-3">최근 내역</h3>
                <div id="recentTransactions" class="space-y-2">
                    <!-- 거래 내역이 여기에 표시됩니다 -->
                </div>
            </div>
        </div>

        <!-- 등급별 자산운용 섹션 -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-chart-pie text-purple-500 mr-2"></i>자산운용
            </h2>
            <p class="text-sm text-gray-500 mb-6">등급이 높아질수록 더 많은 투자 상품을 이용할 수 있습니다</p>
            
            <div class="space-y-4" id="assetProducts">
                <!-- 예적금 (모든 등급 이용 가능) -->
                <div class="asset-item bg-purple-50 rounded-xl p-4 cursor-pointer" onclick="openInvestmentModal('deposit')" id="depositProduct">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-piggy-bank text-purple-500 text-xl"></i>
                            <div>
                                <p class="font-semibold">예적금</p>
                                <p class="text-sm text-gray-500">안전한 저축 상품</p>
                                <p class="text-xs text-blue-500 font-semibold">보유: <span id="depositHolding">0원</span></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="asset-status bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">이용 가능</span>
                        </div>
                    </div>
                </div>
                
                <!-- 주식 (ORANGE 등급부터) -->
                <div class="asset-item bg-blue-50 rounded-xl p-4 cursor-pointer" onclick="openInvestmentModal('stock')" id="stockProduct">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-chart-line text-blue-500 text-xl"></i>
                            <div>
                                <p class="font-semibold">주식</p>
                                <p class="text-sm text-gray-500">국내외 주식 투자</p>
                                <p class="text-xs text-blue-500 font-semibold">보유: <span id="stockHolding">0원</span></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="asset-status bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold">ORANGE+</span>
                        </div>
                    </div>
                </div>
                
                <!-- 채권 (GREEN 등급부터) -->
                <div class="asset-item bg-green-50 rounded-xl p-4 cursor-pointer" onclick="openInvestmentModal('bond')" id="bondProduct">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-certificate text-green-500 text-xl"></i>
                            <div>
                                <p class="font-semibold">채권</p>
                                <p class="text-sm text-gray-500">안정적인 수익</p>
                                <p class="text-xs text-blue-500 font-semibold">보유: <span id="bondHolding">0원</span></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="asset-status bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold">GREEN+</span>
                        </div>
                    </div>
                </div>
                
                <!-- ETF/펀드 (BLUE 등급부터) -->
                <div class="asset-item bg-indigo-50 rounded-xl p-4 cursor-pointer" onclick="openInvestmentModal('etf')" id="etfProduct">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-layer-group text-indigo-500 text-xl"></i>
                            <div>
                                <p class="font-semibold">ETF/펀드</p>
                                <p class="text-sm text-gray-500">분산 투자 상품</p>
                                <p class="text-xs text-blue-500 font-semibold">보유: <span id="etfHolding">0원</span></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="asset-status bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold">BLUE+</span>
                        </div>
                    </div>
                </div>
                
                <!-- 암호화폐 (BROWN 등급부터) -->
                <div class="asset-item bg-yellow-50 rounded-xl p-4 cursor-pointer" onclick="openInvestmentModal('crypto')" id="cryptoProduct">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-coins text-yellow-500 text-xl"></i>
                            <div>
                                <p class="font-semibold">암호화폐</p>
                                <p class="text-sm text-gray-500">디지털 자산</p>
                                <p class="text-xs text-blue-500 font-semibold">보유: <span id="cryptoHolding">0원</span></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="asset-status bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold">BROWN+</span>
                        </div>
                    </div>
                </div>
                
                <!-- 귀금속/원자재 (BLACK 등급부터) -->
                <div class="asset-item bg-gray-50 rounded-xl p-4 cursor-pointer" onclick="openInvestmentModal('commodity')" id="commodityProduct">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-gem text-gray-600 text-xl"></i>
                            <div>
                                <p class="font-semibold">귀금속/원자재</p>
                                <p class="text-sm text-gray-500">실물 투자</p>
                                <p class="text-xs text-blue-500 font-semibold">보유: <span id="commodityHolding">0원</span></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="asset-status bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold">BLACK+</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 포트폴리오 모달 -->
<div id="portfolioModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">내 포트폴리오</h3>
                    <button onclick="hidePortfolioModal()" class="text-gray-500">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- 총 자산 현황 -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-600">총 투자금액</p>
                            <p class="text-lg font-bold" id="totalInvestment">0원</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">평가손익</p>
                            <p class="text-lg font-bold" id="totalProfit">0원</p>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <p class="text-sm text-gray-600">수익률</p>
                        <p class="text-xl font-bold" id="totalReturn">0%</p>
                    </div>
                </div>
                
                <!-- 포트폴리오 차트 -->
                <div class="portfolio-chart mb-6">
                    <div id="portfolioChartLoading" class="text-center py-8">
                        <div class="loading-spinner mx-auto"></div>
                        <p class="text-gray-500 mt-2">포트폴리오 차트 로딩 중...</p>
                    </div>
                    <canvas id="portfolioChart" style="display: none;"></canvas>
                </div>
                
                <!-- 보유 자산 목록 -->
                <div>
                    <h4 class="font-semibold mb-3">보유 자산 현황</h4>
                    <div id="portfolioList" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- 포트폴리오 항목들이 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 투자 모달 -->
<div id="investmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold" id="investmentTitle">투자 상품</h3>
                    <button onclick="hideInvestmentModal()" class="text-gray-500">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- 투자 상품 목록 -->
                <div id="investmentProductList" class="space-y-3 mb-6 max-h-80 overflow-y-auto">
                    <!-- 투자 상품들이 여기에 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 매수/매도 모달 -->
<div id="tradeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold" id="tradeTitle">매수</h3>
                    <button onclick="hideTradeModal()" class="text-gray-500">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- 상품 정보 -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="text-center">
                        <p class="font-semibold text-lg" id="tradeProductName"></p>
                        <p class="text-sm text-gray-600" id="tradeProductType"></p>
                        <p class="text-xl font-bold mt-2" id="tradeProductPrice"></p>
                        <p class="text-sm" id="tradeProductChange"></p>
                    </div>
                </div>
                
                <!-- 거래 탭 -->
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <button id="buyTab" onclick="switchTradeTab('buy')" class="py-2 rounded-lg bg-blue-500 text-white font-semibold">
                        매수
                    </button>
                    <button id="sellTab" onclick="switchTradeTab('sell')" class="py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold">
                        매도
                    </button>
                </div>
                
                <!-- 거래 입력 -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">수량</label>
                        <input type="number" id="tradeQuantity" placeholder="수량 입력" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">예상 금액</label>
                        <input type="text" id="tradeAmount" readonly
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div id="holdingInfo" class="text-sm text-gray-600 hidden">
                        보유 수량: <span id="currentHolding">0</span>개
                    </div>
                </div>
                
                <!-- 거래 버튼 -->
                <button id="tradeButton" onclick="executeTrade()" 
                        class="w-full bg-blue-500 text-white py-3 rounded-xl font-semibold">
                    매수하기
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 수입 추가 모달 -->
<div id="incomeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm modal-content">
            <div class="p-6">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold">수입 추가</h3>
                </div>
                <div class="space-y-4 mb-6">
                    <input type="text" id="incomeAmount" placeholder="금액 (원)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <input type="text" id="incomeCategory" placeholder="분류 (예: 급여, 부업)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <textarea id="incomeMemo" placeholder="메모 (선택사항)" 
                             class="w-full px-4 py-3 border border-gray-300 rounded-lg h-20"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="hideIncomeModal()" 
                            class="bg-gray-300 text-gray-700 py-3 rounded-xl font-semibold">
                        취소
                    </button>
                    <button onclick="addIncome()" 
                            class="bg-green-500 text-white py-3 rounded-xl font-semibold">
                        추가
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 지출 추가 모달 -->
<div id="expenseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm modal-content">
            <div class="p-6">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold">지출 추가</h3>
                </div>
                <div class="space-y-4 mb-6">
                    <input type="text" id="expenseAmount" placeholder="금액 (원)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <input type="text" id="expenseCategory" placeholder="분류 (예: 식비, 교통비)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <textarea id="expenseMemo" placeholder="메모 (선택사항)" 
                             class="w-full px-4 py-3 border border-gray-300 rounded-lg h-20"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="hideExpenseModal()" 
                            class="bg-gray-300 text-gray-700 py-3 rounded-xl font-semibold">
                        취소
                    </button>
                    <button onclick="addExpense()" 
                            class="bg-red-500 text-white py-3 rounded-xl font-semibold">
                        추가
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 거래내역 편집 모달 -->
<div id="editTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm modal-content">
            <div class="p-6">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold">거래내역 편집</h3>
                </div>
                <div class="space-y-4 mb-6">
                    <input type="text" id="editAmount" placeholder="금액 (원)" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <input type="text" id="editCategory" placeholder="분류" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <textarea id="editMemo" placeholder="메모 (선택사항)" 
                             class="w-full px-4 py-3 border border-gray-300 rounded-lg h-20"></textarea>
                    <select id="editType" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                        <option value="income">수입</option>
                        <option value="expense">지출</option>
                    </select>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="hideEditTransactionModal()" 
                            class="bg-gray-300 text-gray-700 py-3 rounded-xl font-semibold">
                        취소
                    </button>
                    <button onclick="deleteTransaction()" 
                            class="bg-red-500 text-white py-3 rounded-xl font-semibold">
                        삭제
                    </button>
                    <button onclick="updateTransaction()" 
                            class="bg-blue-500 text-white py-3 rounded-xl font-semibold">
                        수정
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 거래내역 필터 모달 -->
<div id="filterModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm modal-content">
            <div class="p-6">
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold">거래내역 필터</h3>
                </div>
                <div class="space-y-4 mb-6">
                    <input type="text" id="searchKeyword" placeholder="검색어 입력" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                    <select id="filterType" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                        <option value="">전체</option>
                        <option value="income">수입</option>
                        <option value="expense">지출</option>
                    </select>
                    <select id="filterPeriod" class="w-full px-4 py-3 border border-gray-300 rounded-lg">
                        <option value="all">전체 기간</option>
                        <option value="thisMonth">이번 달</option>
                        <option value="lastMonth">지난 달</option>
                        <option value="thisYear">올해</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="hideFilterModal()" 
                            class="bg-gray-300 text-gray-700 py-3 rounded-xl font-semibold">
                        취소
                    </button>
                    <button onclick="applyFilter()" 
                            class="bg-blue-500 text-white py-3 rounded-xl font-semibold">
                        적용
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 캐시 무력화를 위한 버전 관리
var APP_VERSION = new Date().getTime();

// 전역 변수
var currentUser = JSON.parse(localStorage.getItem('currentUser')) || {
    level: 'yellow',
    exp: 0,
    transactions: [],
    virtualBalance: 1000000,
    portfolio: {
        deposit: [],
        stock: [],
        bond: [],
        etf: [],
        crypto: [],
        commodity: []
    },
    tradeHistory: [], // 거래 내역
    alerts: [], // 알림 설정
    preferences: { // 사용자 설정
        autoAccountBook: true, // 예적금 자동 가계부 반영
        priceAlerts: true, // 가격 알림
        dividendAlerts: true // 배당 알림
    },
    deposits: [] // 예적금 계약 정보
};

var currentUser = JSON.parse(localStorage.getItem('currentUser')) || {
    level: 'yellow',
    exp: 0,
    transactions: [],
    virtualBalance: 1000000,
    portfolio: {
        deposit: [],
        stock: [],
        bond: [],
        etf: [],
        crypto: [],
        commodity: []
    },
    tradeHistory: [], // 거래 내역
    alerts: [], // 알림 설정
    preferences: { // 사용자 설정
        autoAccountBook: true, // 예적금 자동 가계부 반영
        priceAlerts: true, // 가격 알림
        dividendAlerts: true // 배당 알림
    },
    deposits: [] // 예적금 계약 정보
};

var levelSystem = {
    yellow: { name: 'YELLOW', exp: 0, max: 3000, class: 'level-yellow' },
    orange: { name: 'ORANGE', exp: 3000, max: 6000, class: 'level-orange' },
    green: { name: 'GREEN', exp: 6000, max: 10000, class: 'level-green' },
    blue: { name: 'BLUE', exp: 10000, max: 15000, class: 'level-blue' },
    brown: { name: 'BROWN', exp: 15000, max: 25000, class: 'level-brown' },
    black: { name: 'BLACK', exp: 25000, max: 50000, class: 'level-black' },
    red: { name: 'RED', exp: 50000, max: 100000, class: 'level-red' }
};

// 투자 상품 데이터
var investmentProducts = {
    deposit: [
        { id: 'dep1', name: '정기예금 1년', type: '예금', rate: 3.5, price: 10000, minAmount: 10000, duration: 12 },
        { id: 'dep2', name: '정기적금 2년', type: '적금', rate: 4.0, price: 10000, minAmount: 10000, duration: 24 },
        { id: 'dep3', name: '자유적금', type: '적금', rate: 3.8, price: 10000, minAmount: 10000, duration: 6 }
    ],
    stock: [
        { id: 'stk1', name: '삼성전자', type: '주식', price: 75000, change: 2.3, changeAmount: 1700, symbol: '005930.KS' },
        { id: 'stk2', name: 'SK하이닉스', type: '주식', price: 125000, change: -1.5, changeAmount: -1900, symbol: '000660.KS' },
        { id: 'stk3', name: 'NAVER', type: '주식', price: 190000, change: 0.8, changeAmount: 1500, symbol: '035420.KS' },
        { id: 'stk4', name: '카카오', type: '주식', price: 85000, change: -2.1, changeAmount: -1800, symbol: '035720.KS' }
    ],
    bond: [
        { id: 'bnd1', name: '국고채 3년', type: '채권', price: 10000, change: 0.1, changeAmount: 10, rate: 3.2 },
        { id: 'bnd2', name: '회사채 AAA', type: '채권', price: 10000, change: -0.05, changeAmount: -5, rate: 4.1 },
        { id: 'bnd3', name: '지방채', type: '채권', price: 10000, change: 0.2, changeAmount: 20, rate: 3.8 }
    ],
    etf: [
        { id: 'etf1', name: 'KODEX 200', type: 'ETF', price: 35000, change: 1.2, changeAmount: 420 },
        { id: 'etf2', name: 'TIGER 미국S&P500', type: 'ETF', price: 28000, change: 0.9, changeAmount: 250 },
        { id: 'etf3', name: '글로벌펀드', type: '펀드', price: 12000, change: -0.3, changeAmount: -36 }
    ],
    crypto: [
        { id: 'cry1', name: '비트코인', type: '암호화폐', price: 45000000, change: 3.5, changeAmount: 1500000, symbol: 'bitcoin' },
        { id: 'cry2', name: '이더리움', type: '암호화폐', price: 2800000, change: -2.1, changeAmount: -60000, symbol: 'ethereum' },
        { id: 'cry3', name: '리플', type: '암호화폐', price: 650, change: 5.2, changeAmount: 32, symbol: 'ripple' }
    ],
    commodity: [
        { id: 'com1', name: '금', type: '귀금속', price: 80000, change: 0.5, changeAmount: 400 },
        { id: 'com2', name: '은', type: '귀금속', price: 950, change: -1.2, changeAmount: -11 },
        { id: 'com3', name: '원유', type: '원자재', price: 75000, change: 2.8, changeAmount: 2100 }
    ]
};

var budgetChart = null;
var portfolioChart = null;
var currentTradeProduct = null;
var currentTradeType = 'buy';
var priceUpdateInterval = null;
var currentEditingTransaction = null;
var currentTransactionFilter = {
    type: '',
    keyword: '',
    period: 'all'
};

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadUserData();
    updateLevelDisplay();
    updateAssetProducts();
    updateBudgetSummary();
    createBudgetChart();
    updateRecentTransactions();
    updateHoldingDisplays();
    startPriceUpdates();
    startPeriodicTasks();
    
    // 브라우저 알림 권한 요청
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }
    
    // 레벨 변경 시 투자 상품 자동 업데이트 콜백 등록
    if (window.levelManager) {
        window.levelManager.onLevelChange(function(currentLevel, currentExp, oldLevel, newLevel) {
            // 레벨이 변경되었을 때 투자 상품 상태 업데이트
            updateAssetProducts();
            updateLevelDisplay();
            console.log('Investment products updated due to level change');
        });
    }
});

// 사용자 데이터 로드
function loadUserData() {
    var savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        // 포트폴리오 초기화 (기존 데이터 호환성)
        if (!currentUser.portfolio) {
            currentUser.portfolio = {
                deposit: [],
                stock: [],
                bond: [],
                etf: [],
                crypto: [],
                commodity: []
            };
        }
        if (!currentUser.virtualBalance) {
            currentUser.virtualBalance = 1000000;
        }
        if (!currentUser.tradeHistory) {
            currentUser.tradeHistory = [];
        }
        if (!currentUser.alerts) {
            currentUser.alerts = [];
        }
        if (!currentUser.preferences) {
            currentUser.preferences = {
                autoAccountBook: true,
                priceAlerts: true,
                dividendAlerts: true
            };
        }
        if (!currentUser.deposits) {
            currentUser.deposits = [];
        }
    }
}

// 사용자 데이터 저장
function saveUserData() {
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
}

// 레벨 표시 업데이트 (새로운 레벨 매니저 사용)
function updateLevelDisplay() {
    // 레벨 매니저를 통한 통합 레벨 관리
    if (window.levelManager && window.levelManager.currentUser) {
        window.levelManager.updateLevelDisplay();
        
        // 가상 자산 표시 업데이트
        var virtualBalance = document.getElementById('virtualBalance');
        if (virtualBalance) {
            virtualBalance.textContent = currentUser.virtualBalance.toLocaleString() + '원';
        }
        
        return;
    }
    
    // 레거시 방식 (레벨 매니저가 없을 때)
    var level = levelSystem[currentUser.level];
    var levelBadge = document.getElementById('currentLevelBadge');
    var expText = document.getElementById('expText');
    var expBar = document.getElementById('expBar');
    var virtualBalance = document.getElementById('virtualBalance');
    
    if (levelBadge) {
        levelBadge.className = 'inline-block px-6 py-3 rounded-full text-white font-bold text-lg ' + level.class;
        levelBadge.textContent = level.name;
    }
    
    if (expText) {
        expText.textContent = currentUser.exp + ' / ' + level.max + ' EXP';
    }
    
    if (expBar) {
        var percentage = (currentUser.exp / level.max) * 100;
        expBar.style.width = percentage + '%';
    }
    
    if (virtualBalance) {
        virtualBalance.textContent = currentUser.virtualBalance.toLocaleString() + '원';
    }
}

// 등급별 자산 상품 업데이트 (새로운 투자 잠금 시스템)
function updateAssetProducts() {
    // 레벨 매니저를 통해 투자 잠금 상태 확인
    if (window.levelManager) {
        const lockStatus = window.levelManager.getInvestmentLockStatus();
        
        // 예적금 (항상 사용 가능)
        var depositProduct = document.getElementById('depositProduct');
        if (depositProduct) {
            depositProduct.classList.remove('locked');
            var statusElement = depositProduct.querySelector('.asset-status');
            if (statusElement) {
                statusElement.textContent = '이용 가능';
                statusElement.className = 'asset-status bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold';
            }
        }
        
        // 주식
        var stockProduct = document.getElementById('stockProduct');
        if (stockProduct) {
            if (lockStatus.stock.unlocked) {
                stockProduct.classList.remove('locked');
                var statusElement = stockProduct.querySelector('.asset-status');
                if (statusElement) {
                    statusElement.textContent = '이용 가능';
                    statusElement.className = 'asset-status bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold';
                }
            } else {
                stockProduct.classList.add('locked');
                var statusElement = stockProduct.querySelector('.asset-status');
                if (statusElement) {
                    statusElement.textContent = lockStatus.stock.requiredLevel + '+';
                    statusElement.className = 'asset-status bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold';
                }
            }
        }
        
        // 채권
        var bondProduct = document.getElementById('bondProduct');
        if (bondProduct) {
            if (lockStatus.bond.unlocked) {
                bondProduct.classList.remove('locked');
                var statusElement = bondProduct.querySelector('.asset-status');
                if (statusElement) {
                    statusElement.textContent = '이용 가능';
                    statusElement.className = 'asset-status bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold';
                }
            } else {
                bondProduct.classList.add('locked');
                var statusElement = bondProduct.querySelector('.asset-status');
                if (statusElement) {
                    statusElement.textContent = lockStatus.bond.requiredLevel + '+';
                    statusElement.className = 'asset-status bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold';
                }
            }
        }
        
        // ETF/펀드
        var etfProduct = document.getElementById('etfProduct');
        if (etfProduct) {
            if (lockStatus.etf.unlocked) {
                etfProduct.classList.remove('locked');
                var statusElement = etfProduct.querySelector('.asset-status');
                if (statusElement) {
                    statusElement.textContent = '이용 가능';
                    statusElement.className = 'asset-status bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold';
                }
            } else {
                etfProduct.classList.add('locked');
                var statusElement = etfProduct.querySelector('.asset-status');
                if (statusElement) {
                    statusElement.textContent = lockStatus.etf.requiredLevel + '+';
                    statusElement.className = 'asset-status bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold';
                }
            }
        }
        
        // 암호화폐
        var cryptoProduct = document.getElementById('cryptoProduct');
        if (cryptoProduct) {
            if (lockStatus.crypto.unlocked) {
                cryptoProduct.classList.remove('locked');
                var statusElement = cryptoProduct.querySelector('.asset-status');
                if (statusElement) {
                    statusElement.textContent = '이용 가능';
                    statusElement.className = 'asset-status bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold';
                }
            } else {
                cryptoProduct.classList.add('locked');
                var statusElement = cryptoProduct.querySelector('.asset-status');
                if (statusElement) {
                    statusElement.textContent = lockStatus.crypto.requiredLevel + '+';
                    statusElement.className = 'asset-status bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold';
                }
            }
        }
        
        // 귀금속/원자재
        var commodityProduct = document.getElementById('commodityProduct');
        if (commodityProduct) {
            if (lockStatus.commodity.unlocked) {
                commodityProduct.classList.remove('locked');
                var statusElement = commodityProduct.querySelector('.asset-status');
                if (statusElement) {
                    statusElement.textContent = '이용 가능';
                    statusElement.className = 'asset-status bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold';
                }
            } else {
                commodityProduct.classList.add('locked');
                var statusElement = commodityProduct.querySelector('.asset-status');
                if (statusElement) {
                    statusElement.textContent = lockStatus.commodity.requiredLevel + '+';
                    statusElement.className = 'asset-status bg-gray-400 text-white px-3 py-1 rounded-full text-sm font-semibold';
                }
            }
        }
    }
}

// 보유 자산 표시 업데이트
function updateHoldingDisplays() {
    Object.keys(currentUser.portfolio).forEach(function(type) {
        var totalValue = 0;
        currentUser.portfolio[type].forEach(function(holding) {
            var product = findProductById(type, holding.productId);
            if (product) {
                totalValue += holding.quantity * product.price;
            }
        });
        
        var element = document.getElementById(type + 'Holding');
        if (element) {
            element.textContent = totalValue.toLocaleString() + '원';
        }
    });
}

// 상품 ID로 상품 찾기
function findProductById(type, id) {
    if (investmentProducts[type]) {
        return investmentProducts[type].find(function(product) {
            return product.id === id;
        });
    }
    return null;
}

// 가계부 요약 업데이트
function updateBudgetSummary() {
    var totalIncome = 0;
    var totalExpense = 0;
    
    var filteredTransactions = getFilteredTransactions();
    filteredTransactions.forEach(function(transaction) {
        if (transaction.type === 'income') {
            totalIncome += transaction.amount;
        } else {
            totalExpense += transaction.amount;
        }
    });
    
    document.getElementById('totalIncome').textContent = totalIncome.toLocaleString() + '원';
    document.getElementById('totalExpense').textContent = totalExpense.toLocaleString() + '원';
}

// 가계부 차트 생성
function createBudgetChart() {
    try {
        if (typeof Chart === 'undefined') {
            // Chart.js가 로드되지 않은 경우 대체 차트 생성
            createFallbackBudgetChart();
            return;
        }
        
        var ctx = document.getElementById('budgetChart').getContext('2d');
        
        var incomeData = [];
        var expenseData = [];
        var categories = {};
        
        var filteredTransactions = getFilteredTransactions();
        filteredTransactions.forEach(function(transaction) {
            if (!categories[transaction.category]) {
                categories[transaction.category] = { income: 0, expense: 0 };
            }
            
            if (transaction.type === 'income') {
                categories[transaction.category].income += transaction.amount;
            } else {
                categories[transaction.category].expense += transaction.amount;
            }
        });
        
        var labels = Object.keys(categories);
        if (labels.length === 0) {
            labels = ['데이터 없음'];
            incomeData = [0];
            expenseData = [0];
        } else {
            labels.forEach(function(category) {
                incomeData.push(categories[category].income);
                expenseData.push(categories[category].expense);
            });
        }
        
        if (budgetChart) {
            budgetChart.destroy();
        }
        
        budgetChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '수입',
                    data: incomeData,
                    backgroundColor: '#10B981'
                }, {
                    label: '지출',
                    data: expenseData,
                    backgroundColor: '#EF4444'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString() + '원';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    }
                }
            }
        });
        
        // 차트가 성공적으로 생성되면 로딩 숨기기
        document.getElementById('budgetChartLoading').style.display = 'none';
        document.getElementById('budgetChart').style.display = 'block';
        
    } catch (error) {
        console.error('Chart.js 오류:', error);
        createFallbackBudgetChart();
    }
}

// 대체 차트 생성 (Chart.js 없이)
function createFallbackBudgetChart() {
    var container = document.getElementById('budgetChartLoading');
    var filteredTransactions = getFilteredTransactions();
    
    var categories = {};
    filteredTransactions.forEach(function(transaction) {
        if (!categories[transaction.category]) {
            categories[transaction.category] = { income: 0, expense: 0 };
        }
        
        if (transaction.type === 'income') {
            categories[transaction.category].income += transaction.amount;
        } else {
            categories[transaction.category].expense += transaction.amount;
        }
    });
    
    var maxValue = 0;
    Object.keys(categories).forEach(function(category) {
        maxValue = Math.max(maxValue, categories[category].income, categories[category].expense);
    });
    
    var chartHTML = '<div class="p-4"><h4 class="font-semibold mb-3">카테고리별 수입/지출</h4>';
    
    if (Object.keys(categories).length === 0) {
        chartHTML += '<p class="text-gray-500 text-center">데이터가 없습니다</p>';
    } else {
        Object.keys(categories).forEach(function(category) {
            var income = categories[category].income;
            var expense = categories[category].expense;
            var incomeWidth = maxValue > 0 ? (income / maxValue) * 100 : 0;
            var expenseWidth = maxValue > 0 ? (expense / maxValue) * 100 : 0;
            
            chartHTML += '<div class="mb-3">';
            chartHTML += '<div class="flex justify-between text-sm mb-1">';
            chartHTML += '<span class="font-medium">' + category + '</span>';
            chartHTML += '<span class="text-gray-500">수입: ' + income.toLocaleString() + '원 | 지출: ' + expense.toLocaleString() + '원</span>';
            chartHTML += '</div>';
            chartHTML += '<div class="grid grid-cols-2 gap-2">';
            chartHTML += '<div class="bg-gray-200 rounded h-4"><div class="bg-green-500 h-4 rounded" style="width: ' + incomeWidth + '%"></div></div>';
            chartHTML += '<div class="bg-gray-200 rounded h-4"><div class="bg-red-500 h-4 rounded" style="width: ' + expenseWidth + '%"></div></div>';
            chartHTML += '</div>';
            chartHTML += '</div>';
        });
    }
    
    chartHTML += '</div>';
    container.innerHTML = chartHTML;
}

// 최근 거래 내역 업데이트
function updateRecentTransactions() {
    var container = document.getElementById('recentTransactions');
    container.innerHTML = '';
    
    if (!currentUser.transactions || currentUser.transactions.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">거래 내역이 없습니다</p>';
        return;
    }
    
    var filteredTransactions = getFilteredTransactions();
    var recentTransactions = filteredTransactions.slice(-5).reverse();
    
    recentTransactions.forEach(function(transaction, index) {
        var transactionDiv = document.createElement('div');
        transactionDiv.className = 'p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 ' + 
                                  (transaction.type === 'income' ? 'income-item' : 'expense-item');
        transactionDiv.onclick = function() { showEditTransactionModal(transaction, index); };
        
        transactionDiv.innerHTML = 
            '<div class="flex justify-between items-center">' +
            '<div>' +
            '<p class="font-semibold">' + transaction.category + '</p>' +
            (transaction.memo ? '<p class="text-sm text-gray-500">' + transaction.memo + '</p>' : '') +
            '</div>' +
            '<div class="text-right">' +
            '<p class="font-bold ' + (transaction.type === 'income' ? 'text-green-600' : 'text-red-600') + '">' +
            (transaction.type === 'income' ? '+' : '-') + transaction.amount.toLocaleString() + '원</p>' +
            '<p class="text-xs text-gray-400">' + new Date(transaction.date).toLocaleDateString() + '</p>' +
            '</div></div>';
        
        container.appendChild(transactionDiv);
    });
}

// 필터링된 거래내역 가져오기
function getFilteredTransactions() {
    if (!currentUser.transactions) return [];
    
    var filtered = currentUser.transactions.filter(function(transaction) {
        // 타입 필터
        if (currentTransactionFilter.type && transaction.type !== currentTransactionFilter.type) {
            return false;
        }
        
        // 키워드 필터
        if (currentTransactionFilter.keyword) {
            var keyword = currentTransactionFilter.keyword.toLowerCase();
            if (!transaction.category.toLowerCase().includes(keyword) && 
                !transaction.memo.toLowerCase().includes(keyword)) {
                return false;
            }
        }
        
        // 기간 필터
        if (currentTransactionFilter.period !== 'all') {
            var transactionDate = new Date(transaction.date);
            var now = new Date();
            
            switch (currentTransactionFilter.period) {
                case 'thisMonth':
                    if (transactionDate.getMonth() !== now.getMonth() || 
                        transactionDate.getFullYear() !== now.getFullYear()) {
                        return false;
                    }
                    break;
                case 'lastMonth':
                    var lastMonth = new Date(now.getFullYear(), now.getMonth() - 1);
                    if (transactionDate.getMonth() !== lastMonth.getMonth() || 
                        transactionDate.getFullYear() !== lastMonth.getFullYear()) {
                        return false;
                    }
                    break;
                case 'thisYear':
                    if (transactionDate.getFullYear() !== now.getFullYear()) {
                        return false;
                    }
                    break;
            }
        }
        
        return true;
    });
    
    return filtered;
}

// 거래내역 편집 모달 표시
function showEditTransactionModal(transaction, index) {
    currentEditingTransaction = index;
    
    document.getElementById('editAmount').value = transaction.amount;
    document.getElementById('editCategory').value = transaction.category;
    document.getElementById('editMemo').value = transaction.memo || '';
    document.getElementById('editType').value = transaction.type;
    
    document.getElementById('editTransactionModal').classList.remove('hidden');
}

// 거래내역 편집 모달 숨기기
function hideEditTransactionModal() {
    document.getElementById('editTransactionModal').classList.add('hidden');
    currentEditingTransaction = null;
}

// 거래내역 업데이트
function updateTransaction() {
    if (currentEditingTransaction === null) return;
    
    var amount = parseInt(document.getElementById('editAmount').value);
    var category = document.getElementById('editCategory').value;
    var memo = document.getElementById('editMemo').value;
    var type = document.getElementById('editType').value;
    
    if (!amount || !category) {
        alert('금액과 분류를 입력해주세요.');
        return;
    }
    
    var actualIndex = currentUser.transactions.length - 1 - currentEditingTransaction;
    currentUser.transactions[actualIndex] = {
        type: type,
        amount: amount,
        category: category,
        memo: memo,
        date: currentUser.transactions[actualIndex].date // 기존 날짜 유지
    };
    
    saveUserData();
    updateBudgetSummary();
    createBudgetChart();
    updateRecentTransactions();
    hideEditTransactionModal();
    
    alert('거래내역이 수정되었습니다!');
}

// 거래내역 삭제
function deleteTransaction() {
    if (currentEditingTransaction === null) return;
    
    if (!confirm('이 거래내역을 삭제하시겠습니까?')) return;
    
    var actualIndex = currentUser.transactions.length - 1 - currentEditingTransaction;
    currentUser.transactions.splice(actualIndex, 1);
    
    saveUserData();
    updateBudgetSummary();
    createBudgetChart();
    updateRecentTransactions();
    hideEditTransactionModal();
    
    alert('거래내역이 삭제되었습니다!');
}

// 필터 모달 표시
function showFilterModal() {
    document.getElementById('searchKeyword').value = currentTransactionFilter.keyword;
    document.getElementById('filterType').value = currentTransactionFilter.type;
    document.getElementById('filterPeriod').value = currentTransactionFilter.period;
    
    document.getElementById('filterModal').classList.remove('hidden');
}

// 필터 모달 숨기기
function hideFilterModal() {
    document.getElementById('filterModal').classList.add('hidden');
}

// 필터 적용
function applyFilter() {
    currentTransactionFilter.keyword = document.getElementById('searchKeyword').value;
    currentTransactionFilter.type = document.getElementById('filterType').value;
    currentTransactionFilter.period = document.getElementById('filterPeriod').value;
    
    updateRecentTransactions();
    updateBudgetSummary();
    createBudgetChart();
    hideFilterModal();
    
    alert('필터가 적용되었습니다!');
}

// 전체 거래내역 보기
function showTransactionHistory() {
    // 필터 초기화
    currentTransactionFilter = { type: '', keyword: '', period: 'all' };
    updateRecentTransactions();
    updateBudgetSummary();
    createBudgetChart();
    
    alert('전체 거래내역을 표시합니다!');
}

// 투자 모달 열기 (새로운 투자 잠금 시스템)
function openInvestmentModal(type) {
    // 레벨 매니저를 통한 투자 접근 권한 확인
    if (window.levelManager) {
        if (!window.levelManager.hasInvestmentAccess(type)) {
            var requiredLevel = window.levelManager.getRequiredLevelForInvestment(type);
            alert(requiredLevel + ' 등급부터 이용할 수 있습니다.\n\n자산 운용으로 경험치를 쌓아 등급을 올려보세요!');
            return;
        }
    } else {
        // 레거시 방식 (백업용)
        if (isProductLocked(type)) {
            var requiredLevel = getRequiredLevel(type);
            alert(requiredLevel + ' 등급부터 이용할 수 있습니다.');
            return;
        }
    }
    
    var modal = document.getElementById('investmentModal');
    var title = document.getElementById('investmentTitle');
    var productList = document.getElementById('investmentProductList');
    
    var typeNames = {
        deposit: '예적금',
        stock: '주식',
        bond: '채권',
        etf: 'ETF/펀드',
        crypto: '암호화폐',
        commodity: '귀금속/원자재'
    };
    
    title.textContent = typeNames[type];
    productList.innerHTML = '';
    
    investmentProducts[type].forEach(function(product) {
        var productDiv = document.createElement('div');
        productDiv.className = 'investment-item p-4 border border-gray-200 rounded-lg cursor-pointer';
        productDiv.onclick = function() { openTradeModal(type, product); };
        
        var changeClass = product.change >= 0 ? 'price-positive' : 'price-negative';
        var changeIcon = product.change >= 0 ? '▲' : '▼';
        
        var priceDisplay = product.price.toLocaleString() + '원';
        if (type === 'deposit') {
            priceDisplay = '연 ' + product.rate + '%';
        }
        
        var changeDisplay = '';
        if (product.change !== undefined) {
            changeDisplay = '<p class="text-sm ' + changeClass + '">' + changeIcon + ' ' + 
                           Math.abs(product.change) + '% (' + 
                           (product.changeAmount >= 0 ? '+' : '') + product.changeAmount.toLocaleString() + '원)</p>';
        }
        
        // 보유 수량 확인
        var holding = getHolding(type, product.id);
        var holdingDisplay = holding > 0 ? '<p class="text-xs text-blue-500">보유: ' + holding + '개</p>' : '';
        
        productDiv.innerHTML = 
            '<div class="flex justify-between items-center">' +
            '<div>' +
            '<p class="font-semibold">' + product.name + '</p>' +
            '<p class="text-sm text-gray-500">' + product.type + '</p>' +
            holdingDisplay +
            '</div>' +
            '<div class="text-right">' +
            '<p class="font-bold">' + priceDisplay + '</p>' +
            changeDisplay +
            '</div></div>';
        
        productList.appendChild(productDiv);
    });
    
    modal.classList.remove('hidden');
}

// 상품 잠금 상태 확인
function isProductLocked(type) {
    var levels = Object.keys(levelSystem);
    var currentLevelIndex = levels.indexOf(currentUser.level);
    
    var requiredLevels = {
        deposit: 0,
        stock: 1,
        bond: 2,
        etf: 3,
        crypto: 4,
        commodity: 5
    };
    
    return currentLevelIndex < requiredLevels[type];
}

// 필요 등급 반환
function getRequiredLevel(type) {
    var requiredLevels = {
        deposit: 'YELLOW',
        stock: 'ORANGE',
        bond: 'GREEN',
        etf: 'BLUE',
        crypto: 'BROWN',
        commodity: 'BLACK'
    };
    
    return requiredLevels[type];
}

// 보유 수량 조회
function getHolding(type, productId) {
    var holdings = currentUser.portfolio[type] || [];
    var holding = holdings.find(function(h) { return h.productId === productId; });
    return holding ? holding.quantity : 0;
}

// 거래 모달 열기
function openTradeModal(type, product) {
    currentTradeProduct = { type: type, product: product };
    currentTradeType = 'buy';
    
    var modal = document.getElementById('tradeModal');
    var title = document.getElementById('tradeTitle');
    var productName = document.getElementById('tradeProductName');
    var productType = document.getElementById('tradeProductType');
    var productPrice = document.getElementById('tradeProductPrice');
    var productChange = document.getElementById('tradeProductChange');
    var quantityInput = document.getElementById('tradeQuantity');
    var amountInput = document.getElementById('tradeAmount');
    var holdingInfo = document.getElementById('holdingInfo');
    var currentHolding = document.getElementById('currentHolding');
    
    title.textContent = '매수';
    productName.textContent = product.name;
    productType.textContent = product.type;
    
    if (type === 'deposit') {
        productPrice.textContent = '연 ' + product.rate + '%';
        productChange.textContent = '';
    } else {
        productPrice.textContent = product.price.toLocaleString() + '원';
        var changeClass = product.change >= 0 ? 'price-positive' : 'price-negative';
        var changeIcon = product.change >= 0 ? '▲' : '▼';
        productChange.className = 'text-sm ' + changeClass;
        productChange.textContent = changeIcon + ' ' + Math.abs(product.change) + '% (' + 
                                   (product.changeAmount >= 0 ? '+' : '') + product.changeAmount.toLocaleString() + '원)';
    }
    
    // 보유 수량 표시
    var holding = getHolding(type, product.id);
    currentHolding.textContent = holding;
    if (holding > 0) {
        holdingInfo.classList.remove('hidden');
    } else {
        holdingInfo.classList.add('hidden');
    }
    
    // 입력 필드 초기화
    quantityInput.value = '';
    amountInput.value = '';
    
    // 탭 초기화
    switchTradeTab('buy');
    
    modal.classList.remove('hidden');
    
    // 수량 변경 이벤트 리스너
    quantityInput.oninput = updateTradeAmount;
}

// 거래 탭 전환
function switchTradeTab(type) {
    currentTradeType = type;
    
    var buyTab = document.getElementById('buyTab');
    var sellTab = document.getElementById('sellTab');
    var title = document.getElementById('tradeTitle');
    var button = document.getElementById('tradeButton');
    var holdingInfo = document.getElementById('holdingInfo');
    
    if (type === 'buy') {
        buyTab.className = 'py-2 rounded-lg bg-blue-500 text-white font-semibold';
        sellTab.className = 'py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold';
        title.textContent = '매수';
        button.textContent = '매수하기';
        button.className = 'w-full bg-blue-500 text-white py-3 rounded-xl font-semibold';
        holdingInfo.classList.add('hidden');
    } else {
        buyTab.className = 'py-2 rounded-lg bg-gray-200 text-gray-700 font-semibold';
        sellTab.className = 'py-2 rounded-lg bg-red-500 text-white font-semibold';
        title.textContent = '매도';
        button.textContent = '매도하기';
        button.className = 'w-full bg-red-500 text-white py-3 rounded-xl font-semibold';
        holdingInfo.classList.remove('hidden');
    }
    
    // 수량 초기화
    document.getElementById('tradeQuantity').value = '';
    document.getElementById('tradeAmount').value = '';
}

// 거래 금액 업데이트
function updateTradeAmount() {
    var quantity = parseInt(document.getElementById('tradeQuantity').value) || 0;
    var product = currentTradeProduct.product;
    var type = currentTradeProduct.type;
    
    var price = type === 'deposit' ? product.minAmount : product.price;
    var amount = quantity * price;
    
    document.getElementById('tradeAmount').value = amount.toLocaleString() + '원';
}

// 거래 실행
function executeTrade() {
    var quantity = parseInt(document.getElementById('tradeQuantity').value);
    var product = currentTradeProduct.product;
    var type = currentTradeProduct.type;
    
    if (!quantity || quantity <= 0) {
        showToast('수량을 입력해주세요.', 'warning');
        return;
    }
    
    var price = type === 'deposit' ? product.minAmount : product.price;
    var totalAmount = quantity * price;
    
    if (currentTradeType === 'buy') {
        // 매수
        if (currentUser.virtualBalance < totalAmount) {
            showToast('가상 자산이 부족합니다. (부족: ' + (totalAmount - currentUser.virtualBalance).toLocaleString() + '원)', 'error');
            return;
        }
        
        // 가상 자산 차감
        currentUser.virtualBalance -= totalAmount;
        
        // 포트폴리오에 추가
        var existingHolding = currentUser.portfolio[type].find(function(h) {
            return h.productId === product.id;
        });
        
        if (type === 'deposit') {
            // 예적금은 별도 계약으로 관리
            var contract = createDepositContract(product, quantity);
            
            // 포트폴리오에는 계약 참조 추가
            currentUser.portfolio[type].push({
                productId: product.id,
                quantity: quantity,
                avgPrice: price,
                purchaseDate: new Date().toISOString(),
                depositId: contract.id
            });
        } else {
            if (existingHolding) {
                existingHolding.quantity += quantity;
                existingHolding.avgPrice = ((existingHolding.avgPrice * (existingHolding.quantity - quantity)) + (price * quantity)) / existingHolding.quantity;
            } else {
                currentUser.portfolio[type].push({
                    productId: product.id,
                    quantity: quantity,
                    avgPrice: price,
                    purchaseDate: new Date().toISOString()
                });
            }
        }
        
        // 거래내역 기록
        recordTrade('buy', type, product, quantity, price, totalAmount);
        
        // 예적금의 경우 자동 가계부 반영
        if (type === 'deposit' && currentUser.preferences.autoAccountBook) {
            addAutoTransaction('expense', totalAmount, '예적금', product.name + ' 가입');
        }
        
        // 경험치 추가
        var expGained = Math.floor(totalAmount / 10000) * 10;
        currentUser.exp += expGained;
        
        // 향상된 피드백
        showTradeSuccess('buy', product.name, quantity, totalAmount);
        animateExpGain(expGained);
        
    } else {
        // 매도
        var holding = getHolding(type, product.id);
        if (holding < quantity) {
            showToast('보유 수량이 부족합니다.', 'error');
            return;
        }
        
        // 가상 자산 증가
        currentUser.virtualBalance += totalAmount;
        
        // 포트폴리오에서 차감
        var holdingIndex = currentUser.portfolio[type].findIndex(function(h) {
            return h.productId === product.id;
        });
        
        if (holdingIndex !== -1) {
            currentUser.portfolio[type][holdingIndex].quantity -= quantity;
            
            // 수량이 0이 되면 제거
            if (currentUser.portfolio[type][holdingIndex].quantity <= 0) {
                currentUser.portfolio[type].splice(holdingIndex, 1);
            }
        }
        
        // 거래내역 기록
        recordTrade('sell', type, product, quantity, price, totalAmount);
        
        // 예적금의 경우 자동 가계부 반영
        if (type === 'deposit' && currentUser.preferences.autoAccountBook) {
            addAutoTransaction('income', totalAmount, '예적금', product.name + ' 해지');
        }
        
        // 경험치 추가
        var expGained = Math.floor(totalAmount / 10000) * 5;
        currentUser.exp += expGained;
        
        // 향상된 피드백
        showTradeSuccess('sell', product.name, quantity, totalAmount);
        animateExpGain(expGained);
    }
    
    saveUserData();
    updateLevelDisplay();
    updateHoldingDisplays();
    hideTradeModal();
    hideInvestmentModal();
}

// 거래내역 기록
function recordTrade(action, assetType, product, quantity, price, totalAmount) {
    if (!currentUser.tradeHistory) {
        currentUser.tradeHistory = [];
    }
    
    currentUser.tradeHistory.push({
        action: action, // 'buy' or 'sell'
        assetType: assetType,
        productId: product.id,
        productName: product.name,
        quantity: quantity,
        price: price,
        totalAmount: totalAmount,
        date: new Date().toISOString(),
        profit: action === 'sell' ? calculateTradeProfit(assetType, product.id, quantity, price) : 0
    });
}

// 거래 수익 계산
function calculateTradeProfit(assetType, productId, quantity, sellPrice) {
    var holdings = currentUser.portfolio[assetType] || [];
    var holding = holdings.find(function(h) { return h.productId === productId; });
    
    if (holding) {
        return (sellPrice - holding.avgPrice) * quantity;
    }
    return 0;
}

// 자동 가계부 기록 추가
function addAutoTransaction(type, amount, category, memo) {
    if (!currentUser.transactions) {
        currentUser.transactions = [];
    }
    
    currentUser.transactions.push({
        type: type,
        amount: amount,
        category: category,
        memo: memo + ' (자동 기록)',
        date: new Date().toISOString(),
        linkedInvestment: true
    });
}

// 포트폴리오 모달 표시
function showPortfolioModal() {
    var modal = document.getElementById('portfolioModal');
    updatePortfolioSummary();
    createPortfolioChart();
    updatePortfolioList();
    modal.classList.remove('hidden');
}

// 포트폴리오 요약 업데이트
function updatePortfolioSummary() {
    var totalInvestment = 0;
    var totalCurrentValue = 0;
    
    Object.keys(currentUser.portfolio).forEach(function(type) {
        currentUser.portfolio[type].forEach(function(holding) {
            var product = findProductById(type, holding.productId);
            if (product) {
                var investmentValue = holding.quantity * holding.avgPrice;
                var currentValue = holding.quantity * (type === 'deposit' ? holding.avgPrice : product.price);
                
                totalInvestment += investmentValue;
                totalCurrentValue += currentValue;
            }
        });
    });
    
    var totalProfit = totalCurrentValue - totalInvestment;
    var totalReturn = totalInvestment > 0 ? ((totalProfit / totalInvestment) * 100) : 0;
    
    document.getElementById('totalInvestment').textContent = totalInvestment.toLocaleString() + '원';
    document.getElementById('totalProfit').textContent = totalProfit.toLocaleString() + '원';
    document.getElementById('totalReturn').textContent = totalReturn.toFixed(2) + '%';
    
    // 수익률에 따른 색상 변경
    var profitElement = document.getElementById('totalProfit');
    var returnElement = document.getElementById('totalReturn');
    
    if (totalProfit >= 0) {
        profitElement.className = 'text-lg font-bold text-green-600';
        returnElement.className = 'text-xl font-bold text-green-600';
    } else {
        profitElement.className = 'text-lg font-bold text-red-600';
        returnElement.className = 'text-xl font-bold text-red-600';
    }
}

// 포트폴리오 차트 생성
function createPortfolioChart() {
    try {
        if (typeof Chart === 'undefined') {
            // Chart.js가 로드되지 않은 경우 대체 차트 생성
            createFallbackPortfolioChart();
            return;
        }
        
        var ctx = document.getElementById('portfolioChart').getContext('2d');
        
        var data = [];
        var labels = [];
        var colors = ['#8B5CF6', '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#6B7280'];
        var colorIndex = 0;
        
        Object.keys(currentUser.portfolio).forEach(function(type) {
            var typeValue = 0;
            currentUser.portfolio[type].forEach(function(holding) {
                var product = findProductById(type, holding.productId);
                if (product) {
                    typeValue += holding.quantity * (type === 'deposit' ? holding.avgPrice : product.price);
                }
            });
            
            if (typeValue > 0) {
                var typeNames = {
                    deposit: '예적금',
                    stock: '주식',
                    bond: '채권',
                    etf: 'ETF/펀드',
                    crypto: '암호화폐',
                    commodity: '귀금속/원자재'
                };
                
                labels.push(typeNames[type]);
                data.push(typeValue);
            }
        });
        
        if (data.length === 0) {
            labels = ['투자 없음'];
            data = [1];
        }
        
        if (portfolioChart) {
            portfolioChart.destroy();
        }
        
        portfolioChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, data.length)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // 차트가 성공적으로 생성되면 로딩 숨기기
        document.getElementById('portfolioChartLoading').style.display = 'none';
        document.getElementById('portfolioChart').style.display = 'block';
        
    } catch (error) {
        console.error('Portfolio Chart.js 오류:', error);
        createFallbackPortfolioChart();
    }
}

// 대체 포트폴리오 차트 생성
function createFallbackPortfolioChart() {
    var container = document.getElementById('portfolioChartLoading');
    
    var portfolioData = [];
    var totalValue = 0;
    
    Object.keys(currentUser.portfolio).forEach(function(type) {
        var typeValue = 0;
        currentUser.portfolio[type].forEach(function(holding) {
            var product = findProductById(type, holding.productId);
            if (product) {
                typeValue += holding.quantity * (type === 'deposit' ? holding.avgPrice : product.price);
            }
        });
        
        if (typeValue > 0) {
            var typeNames = {
                deposit: '예적금',
                stock: '주식', 
                bond: '채권',
                etf: 'ETF/펀드',
                crypto: '암호화폐',
                commodity: '귀금속/원자재'
            };
            
            portfolioData.push({
                name: typeNames[type],
                value: typeValue
            });
            totalValue += typeValue;
        }
    });
    
    var chartHTML = '<div class="p-4"><h4 class="font-semibold mb-3">포트폴리오 구성</h4>';
    
    if (portfolioData.length === 0) {
        chartHTML += '<p class="text-gray-500 text-center">투자 내역이 없습니다</p>';
    } else {
        var colors = ['bg-purple-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-red-500', 'bg-gray-500'];
        
        portfolioData.forEach(function(item, index) {
            var percentage = ((item.value / totalValue) * 100).toFixed(1);
            var colorClass = colors[index % colors.length];
            
            chartHTML += '<div class="flex items-center justify-between mb-2">';
            chartHTML += '<div class="flex items-center">';
            chartHTML += '<div class="w-4 h-4 ' + colorClass + ' rounded mr-2"></div>';
            chartHTML += '<span class="text-sm">' + item.name + '</span>';
            chartHTML += '</div>';
            chartHTML += '<div class="text-right">';
            chartHTML += '<span class="text-sm font-medium">' + item.value.toLocaleString() + '원</span>';
            chartHTML += '<div class="text-xs text-gray-500">' + percentage + '%</div>';
            chartHTML += '</div>';
            chartHTML += '</div>';
            
            // 프로그레스 바
            chartHTML += '<div class="mb-3">';
            chartHTML += '<div class="bg-gray-200 rounded-full h-2">';
            chartHTML += '<div class="h-2 ' + colorClass + ' rounded-full" style="width: ' + percentage + '%"></div>';
            chartHTML += '</div>';
            chartHTML += '</div>';
        });
    }
    
    chartHTML += '</div>';
    container.innerHTML = chartHTML;
}

// 포트폴리오 목록 업데이트
function updatePortfolioList() {
    var container = document.getElementById('portfolioList');
    container.innerHTML = '';
    
    var hasHoldings = false;
    
    Object.keys(currentUser.portfolio).forEach(function(type) {
        currentUser.portfolio[type].forEach(function(holding) {
            var product = findProductById(type, holding.productId);
            if (product && holding.quantity > 0) {
                hasHoldings = true;
                
                var investmentValue = holding.quantity * holding.avgPrice;
                var currentValue = holding.quantity * (type === 'deposit' ? holding.avgPrice : product.price);
                var profit = currentValue - investmentValue;
                var returnRate = ((profit / investmentValue) * 100);
                
                var itemDiv = document.createElement('div');
                itemDiv.className = 'p-3 bg-gray-50 rounded-lg';
                
                var profitClass = profit >= 0 ? 'text-green-600' : 'text-red-600';
                var profitIcon = profit >= 0 ? '+' : '';
                
                itemDiv.innerHTML = 
                    '<div class="flex justify-between items-center">' +
                    '<div>' +
                    '<p class="font-semibold">' + product.name + '</p>' +
                    '<p class="text-sm text-gray-500">' + holding.quantity + '개 보유</p>' +
                    '</div>' +
                    '<div class="text-right">' +
                    '<p class="font-bold">' + currentValue.toLocaleString() + '원</p>' +
                    '<p class="text-sm ' + profitClass + '">' + profitIcon + profit.toLocaleString() + '원 (' + returnRate.toFixed(2) + '%)</p>' +
                    '</div></div>';
                
                container.appendChild(itemDiv);
            }
        });
    });
    
    if (!hasHoldings) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">보유 자산이 없습니다</p>';
    }
}

// 가격 업데이트 시작
function startPriceUpdates() {
    // 실시간 가격 업데이트 시작
    priceUpdateInterval = setInterval(function() {
        updateRealTimePrices();
    }, 60000); // 1분마다 업데이트
    
    // 초기 가격 로드
    updateRealTimePrices();
}

// 실시간 가격 업데이트
async function updateRealTimePrices() {
    try {
        // 암호화폐 가격 업데이트 (CoinGecko API)
        await updateCryptoPrices();
        
        // 주식 가격 업데이트는 시뮬레이션 (실제 API는 유료)
        updateStockPricesSimulation();
        
        // 기타 상품은 시뮬레이션
        updateOtherPricesSimulation();
        
        console.log('가격 업데이트 완료:', new Date().toLocaleTimeString());
    } catch (error) {
        console.error('가격 업데이트 오류:', error);
        // 오류 시 시뮬레이션으로 대체
        updatePricesSimulation();
    }
}

// 암호화폐 가격 업데이트 (CoinGecko API)
async function updateCryptoPrices() {
    try {
        const cryptoSymbols = investmentProducts.crypto
            .map(product => product.symbol)
            .filter(symbol => symbol)
            .join(',');
        
        if (!cryptoSymbols) return;
        
        const response = await fetch(
            `https://api.coingecko.com/api/v3/simple/price?ids=${cryptoSymbols}&vs_currencies=krw&include_24hr_change=true`,
            {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            }
        );
        
        if (!response.ok) {
            throw new Error('CoinGecko API 응답 오류');
        }
        
        const data = await response.json();
        
        investmentProducts.crypto.forEach(function(product) {
            if (product.symbol && data[product.symbol]) {
                const newPrice = Math.floor(data[product.symbol].krw);
                const change24h = data[product.symbol].krw_24h_change || 0;
                
                const oldPrice = product.price;
                product.price = newPrice;
                product.change = change24h;
                product.changeAmount = newPrice - oldPrice;
            }
        });
        
        console.log('암호화폐 가격 업데이트 완료');
    } catch (error) {
        console.warn('암호화폐 API 오류, 시뮬레이션 사용:', error.message);
    }
}

// 주식 가격 시뮬레이션 (실제 API는 유료)
function updateStockPricesSimulation() {
    investmentProducts.stock.forEach(function(product) {
        // 장시간 확인 (한국 시간 9:00-15:30)
        const now = new Date();
        const hour = now.getHours();
        const isMarketTime = hour >= 9 && hour < 16;
        
        if (isMarketTime) {
            // 장중에는 더 작은 변동
            const changePercent = (Math.random() - 0.5) * 2; // -1% ~ +1%
            const changeAmount = Math.floor(product.price * (changePercent / 100));
            
            product.price += changeAmount;
            product.change = changePercent;
            product.changeAmount = changeAmount;
        }
        
        // 최소값 보정
        if (product.price < 1000) product.price = 1000;
    });
}

// 기타 상품 가격 시뮬레이션
function updateOtherPricesSimulation() {
    ['bond', 'etf', 'commodity'].forEach(function(type) {
        if (type !== 'deposit') { // 예적금은 금리 고정
            investmentProducts[type].forEach(function(product) {
                // -1% ~ +1% 범위에서 랜덤 변동
                const changePercent = (Math.random() - 0.5) * 2;
                const changeAmount = Math.floor(product.price * (changePercent / 100));
                
                product.price += changeAmount;
                product.change = changePercent;
                product.changeAmount = changeAmount;
                
                // 최소값 보정
                if (product.price < 100) product.price = 100;
            });
        }
    });
}

// 가격 변동 시뮬레이션 (백업용)
function updatePricesSimulation() {
    Object.keys(investmentProducts).forEach(function(type) {
        if (type !== 'deposit') { // 예적금은 금리 고정
            investmentProducts[type].forEach(function(product) {
                // -3% ~ +3% 범위에서 랜덤 변동
                var changePercent = (Math.random() - 0.5) * 6;
                var changeAmount = Math.floor(product.price * (changePercent / 100));
                
                product.price += changeAmount;
                product.change = changePercent;
                product.changeAmount = changeAmount;
                
                // 최소값 보정
                if (product.price < 1000) product.price = 1000;
            });
        }
    });
    
    // 현재 열린 모달이 있다면 업데이트
    if (!document.getElementById('investmentModal').classList.contains('hidden')) {
        // 투자 모달 업데이트 로직이 필요하다면 여기에 추가
    }
}

// 수입 추가 모달 표시
function showAddIncomeModal() {
    document.getElementById('incomeModal').classList.remove('hidden');
}

// 수입 추가 모달 숨기기
function hideIncomeModal() {
    document.getElementById('incomeModal').classList.add('hidden');
    document.getElementById('incomeAmount').value = '';
    document.getElementById('incomeCategory').value = '';
    document.getElementById('incomeMemo').value = '';
}

// 지출 추가 모달 표시
function showAddExpenseModal() {
    document.getElementById('expenseModal').classList.remove('hidden');
}

// 지출 추가 모달 숨기기
function hideExpenseModal() {
    document.getElementById('expenseModal').classList.add('hidden');
    document.getElementById('expenseAmount').value = '';
    document.getElementById('expenseCategory').value = '';
    document.getElementById('expenseMemo').value = '';
}

// 포트폴리오 모달 숨기기
function hidePortfolioModal() {
    document.getElementById('portfolioModal').classList.add('hidden');
}

// 투자 모달 숨기기
function hideInvestmentModal() {
    document.getElementById('investmentModal').classList.add('hidden');
}

// 거래 모달 숨기기
function hideTradeModal() {
    document.getElementById('tradeModal').classList.add('hidden');
    currentTradeProduct = null;
}

// 수입 추가
function addIncome() {
    var amount = parseInt(document.getElementById('incomeAmount').value);
    var category = document.getElementById('incomeCategory').value;
    var memo = document.getElementById('incomeMemo').value;
    
    if (!amount || !category) {
        alert('금액과 분류를 입력해주세요.');
        return;
    }
    
    if (!currentUser.transactions) {
        currentUser.transactions = [];
    }
    
    currentUser.transactions.push({
        type: 'income',
        amount: amount,
        category: category,
        memo: memo,
        date: new Date().toISOString()
    });
    
    currentUser.exp += 50;
    
    saveUserData();
    updateLevelDisplay();
    updateBudgetSummary();
    createBudgetChart();
    updateRecentTransactions();
    hideIncomeModal();
    
    alert('수입이 추가되었습니다! (+50 EXP)');
}

// 지출 추가
function addExpense() {
    var amount = parseInt(document.getElementById('expenseAmount').value);
    var category = document.getElementById('expenseCategory').value;
    var memo = document.getElementById('expenseMemo').value;
    
    if (!amount || !category) {
        alert('금액과 분류를 입력해주세요.');
        return;
    }
    
    if (!currentUser.transactions) {
        currentUser.transactions = [];
    }
    
    currentUser.transactions.push({
        type: 'expense',
        amount: amount,
        category: category,
        memo: memo,
        date: new Date().toISOString()
    });
    
    currentUser.exp += 30;
    
    saveUserData();
    updateLevelDisplay();
    updateBudgetSummary();
    createBudgetChart();
    updateRecentTransactions();
    hideExpenseModal();
    
    alert('지출이 추가되었습니다! (+30 EXP)');
}

// 배당금/이자 지급 시스템
function processDividendsAndInterest() {
    var now = new Date();
    var totalDividends = 0;
    
    // 주식 배당금 (월 1회)
    if (now.getDate() === 1) { // 매월 1일
        Object.keys(currentUser.portfolio).forEach(function(type) {
            if (type === 'stock') {
                currentUser.portfolio[type].forEach(function(holding) {
                    var product = findProductById(type, holding.productId);
                    if (product) {
                        // 배당률 2% 가정 (연간)
                        var dividendRate = 0.02 / 12; // 월 배당률
                        var dividend = Math.floor(holding.quantity * holding.avgPrice * dividendRate);
                        
                        if (dividend > 0) {
                            currentUser.virtualBalance += dividend;
                            totalDividends += dividend;
                            
                            // 자동 가계부 반영
                            if (currentUser.preferences.autoAccountBook) {
                                addAutoTransaction('income', dividend, '배당금', product.name + ' 배당금');
                            }
                        }
                    }
                });
            }
        });
    }
    
    // 예적금 이자 (월 1회)
    currentUser.deposits.forEach(function(deposit) {
        var depositDate = new Date(deposit.startDate);
        var monthsPassed = (now.getFullYear() - depositDate.getFullYear()) * 12 + 
                          (now.getMonth() - depositDate.getMonth());
        
        if (monthsPassed > 0 && !deposit.interestPaid[monthsPassed]) {
            var monthlyInterest = Math.floor(deposit.amount * (deposit.rate / 100) / 12);
            currentUser.virtualBalance += monthlyInterest;
            totalDividends += monthlyInterest;
            
            deposit.interestPaid[monthsPassed] = true;
            
            // 자동 가계부 반영
            if (currentUser.preferences.autoAccountBook) {
                addAutoTransaction('income', monthlyInterest, '이자수익', deposit.productName + ' 이자');
            }
        }
        
        // 만기 확인
        if (monthsPassed >= deposit.duration && !deposit.matured) {
            var maturityAmount = deposit.amount + Math.floor(deposit.amount * (deposit.rate / 100) * (deposit.duration / 12));
            currentUser.virtualBalance += maturityAmount;
            deposit.matured = true;
            
            // 자동 가계부 반영
            if (currentUser.preferences.autoAccountBook) {
                addAutoTransaction('income', maturityAmount, '만기수익', deposit.productName + ' 만기환급');
            }
            
            // 포트폴리오에서 제거
            var portfolioIndex = currentUser.portfolio.deposit.findIndex(function(h) {
                return h.depositId === deposit.id;
            });
            if (portfolioIndex !== -1) {
                currentUser.portfolio.deposit.splice(portfolioIndex, 1);
            }
        }
    });
    
    if (totalDividends > 0) {
        saveUserData();
        updateLevelDisplay();
        updateBudgetSummary();
        updateRecentTransactions();
        
        if (currentUser.preferences.dividendAlerts) {
            showNotification('배당/이자 지급', totalDividends.toLocaleString() + '원이 지급되었습니다!');
        }
    }
}

// 가격 알림 확인
function checkPriceAlerts() {
    currentUser.alerts.forEach(function(alert, index) {
        if (!alert.triggered) {
            var product = findProductById(alert.assetType, alert.productId);
            if (product) {
                var shouldTrigger = false;
                var message = '';
                
                if (alert.type === 'target' && product.price >= alert.targetPrice) {
                    shouldTrigger = true;
                    message = alert.productName + '이(가) 목표가 ' + alert.targetPrice.toLocaleString() + '원에 도달했습니다!';
                } else if (alert.type === 'loss' && product.price <= alert.targetPrice) {
                    shouldTrigger = true;
                    message = alert.productName + '이(가) 손실 한계 ' + alert.targetPrice.toLocaleString() + '원에 도달했습니다!';
                }
                
                if (shouldTrigger) {
                    alert.triggered = true;
                    alert.triggeredDate = new Date().toISOString();
                    
                    if (currentUser.preferences.priceAlerts) {
                        showNotification('가격 알림', message);
                    }
                }
            }
        }
    });
    
    saveUserData();
}

// 알림 표시
function showNotification(title, message) {
    // 브라우저 알림 지원 확인
    if ("Notification" in window) {
        if (Notification.permission === "granted") {
            new Notification(title, {
                body: message,
                icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
            });
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(function(permission) {
                if (permission === "granted") {
                    new Notification(title, { body: message });
                }
            });
        }
    }
    
    // 토스트 메시지로도 표시
    showToast(title + ': ' + message);
}

// 토스트 메시지 표시 (개선된 버전)
function showToast(message, type = 'info') {
    var toast = document.createElement('div');
    toast.className = 'notification-toast p-4 mb-2';
    
    var bgColor = 'bg-blue-600';
    var icon = 'fas fa-info-circle';
    
    switch (type) {
        case 'success':
            bgColor = 'bg-green-600';
            icon = 'fas fa-check-circle';
            break;
        case 'warning':
            bgColor = 'bg-yellow-600';
            icon = 'fas fa-exclamation-triangle';
            break;
        case 'error':
            bgColor = 'bg-red-600';
            icon = 'fas fa-times-circle';
            break;
    }
    
    toast.innerHTML = 
        '<div class="' + bgColor + ' text-white rounded-lg p-3 shadow-lg">' +
        '<div class="flex items-center">' +
        '<i class="' + icon + ' mr-2"></i>' +
        '<span class="text-sm font-medium">' + message + '</span>' +
        '</div></div>';
    
    document.body.appendChild(toast);
    
    // 애니메이션으로 표시
    setTimeout(function() {
        toast.classList.add('show');
    }, 100);
    
    // 3초 후 자동 제거
    setTimeout(function() {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(function() {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// 거래 완료 시 향상된 피드백
function showTradeSuccess(action, productName, quantity, amount) {
    var message = action === 'buy' ? 
        productName + ' ' + quantity + '개 매수 완료! (' + amount.toLocaleString() + '원)' :
        productName + ' ' + quantity + '개 매도 완료! (' + amount.toLocaleString() + '원)';
    
    showToast(message, 'success');
    
    // 레벨 바 애니메이션
    var expBar = document.getElementById('expBar');
    if (expBar) {
        expBar.style.transition = 'width 0.5s ease';
    }
}

// 경험치 증가 애니메이션
function animateExpGain(expGained) {
    var expText = document.getElementById('expText');
    if (expText) {
        // 경험치 증가 표시
        var gainIndicator = document.createElement('div');
        gainIndicator.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 ' +
                                 'bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-lg z-50';
        gainIndicator.textContent = '+' + expGained + ' EXP';
        gainIndicator.style.animation = 'bounce 0.6s ease-out';
        
        document.body.appendChild(gainIndicator);
        
        setTimeout(function() {
            if (document.body.contains(gainIndicator)) {
                document.body.removeChild(gainIndicator);
            }
        }, 1000);
    }
}

// 가격 변동 시각적 피드백
function flashPriceChange(element, isIncrease) {
    if (!element) return;
    
    var flashClass = isIncrease ? 'price-flash-green' : 'price-flash-red';
    element.classList.add(flashClass);
    
    setTimeout(function() {
        element.classList.remove(flashClass);
    }, 500);
}

// 예적금 계약 생성
function createDepositContract(product, quantity) {
    var contract = {
        id: 'dep_' + Date.now(),
        productId: product.id,
        productName: product.name,
        amount: quantity * product.minAmount,
        rate: product.rate,
        duration: product.duration,
        startDate: new Date().toISOString(),
        interestPaid: {},
        matured: false
    };
    
    if (!currentUser.deposits) {
        currentUser.deposits = [];
    }
    
    currentUser.deposits.push(contract);
    return contract;
}

// 정기 작업 실행 (1분마다)
function runPeriodicTasks() {
    processDividendsAndInterest();
    checkPriceAlerts();
}

// 페이지 로드 시 정기 작업 시작
function startPeriodicTasks() {
    // 배당/이자 및 알림 확인 (1분마다)
    setInterval(runPeriodicTasks, 60000);
    
    // 초기 실행
    runPeriodicTasks();
}
function goToIndex() {
    window.location.href = 'index.html?v=' + APP_VERSION;
}

// 모달 외부 클릭 시 닫기
document.getElementById('incomeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideIncomeModal();
    }
});

document.getElementById('expenseModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideExpenseModal();
    }
});

document.getElementById('portfolioModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hidePortfolioModal();
    }
});

document.getElementById('investmentModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideInvestmentModal();
    }
});

document.getElementById('tradeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideTradeModal();
    }
});

document.getElementById('editTransactionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideEditTransactionModal();
    }
});

document.getElementById('filterModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideFilterModal();
    }
});

// 페이지 언로드 시 인터벌 정리
window.addEventListener('beforeunload', function() {
    if (priceUpdateInterval) {
        clearInterval(priceUpdateInterval);
    }
});
</script>

</body>
</html>

