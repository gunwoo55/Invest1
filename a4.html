<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINE U - 게임</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            zoom: 1;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        .screen {
            display: none;
            min-height: 100vh;
            position: relative;
        }
        .screen.active {
            display: block;
        }
        .card-shadow {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #4A6FA5, #6B8DC7);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 111, 165, 0.3);
        }
        
        .level-badge-nav {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }
        
        .level-yellow { background: linear-gradient(135deg, #FCD34D, #F59E0B); }
        .level-orange { background: linear-gradient(135deg, #FB923C, #EA580C); }
        .level-green { background: linear-gradient(135deg, #34D399, #059669); }
        .level-blue { background: linear-gradient(135deg, #60A5FA, #2563EB); }
        .level-brown { background: linear-gradient(135deg, #A16207, #92400E); }
        .level-black { background: linear-gradient(135deg, #374151, #111827); }
        .level-red { background: linear-gradient(135deg, #EF4444, #DC2626); }

        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 12px 0 8px 0;
            z-index: 50;
        }

        .nav-container {
            max-width: 28rem;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            align-items: end;
            position: relative;
            height: 60px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 4px;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            transform: translateY(-1px);
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item span {
            font-size: 11px;
            font-weight: 500;
        }

        .nav-item.active i {
            color: #3B82F6;
        }

        .nav-item.active span {
            color: #3B82F6;
        }

        .nav-center {
            grid-column: 3;
            display: flex;
            justify-content: center;
            align-items: end;
            height: 100%;
            position: relative;
        }

        .game-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .game-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .game-canvas {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f8fafc;
            margin: 16px 0;
        }

        .game-button {
            background: linear-gradient(135deg, #4A6FA5, #6B8DC7);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 111, 165, 0.3);
        }

        .ranking-badge {
            background: linear-gradient(135deg, #FCD34D, #F59E0B);
            color: #92400E;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .rocket {
            width: 40px;
            height: 60px;
            background: linear-gradient(135deg, #EF4444, #DC2626);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            position: absolute;
            transition: all 0.1s ease;
        }

        .enemy {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            position: absolute;
        }

        .bullet {
            width: 4px;
            height: 12px;
            background: #FCD34D;
            position: absolute;
            border-radius: 2px;
        }

        .owl-character {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            display: block;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .owl-character:hover {
            transform: scale(1.1);
        }

        .character-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 0 auto;
            cursor: pointer;
        }

        .character-sprite {
            font-size: 100px;
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #FEF3C7, #FCD34D);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            margin: 10px auto;
            position: relative;
            z-index: 1;
        }

        .character-sprite:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }

        .character-sprite.happy {
            animation: bounce 0.6s ease-in-out;
        }

        .character-sprite.level-up {
            animation: levelUpGlow 1s ease-in-out;
        }

        .character-effects {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 2;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0) scale(1); }
            40% { transform: translateY(-20px) scale(1.1); }
            60% { transform: translateY(-10px) scale(1.05); }
        }

        @keyframes levelUpGlow {
            0% { box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
            50% { box-shadow: 0 12px 40px rgba(255,215,0,0.6); }
            100% { box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
        }

        @keyframes heartFloat {
            0% { opacity: 1; transform: translateY(0) scale(0.8); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }

        .floating-heart {
            position: absolute;
            color: #EF4444;
            font-size: 24px;
            animation: heartFloat 1s ease-out forwards;
        }

        .floating-exp {
            position: absolute;
            color: #059669;
            font-size: 14px;
            font-weight: bold;
            animation: heartFloat 1s ease-out forwards;
        }

        .exp-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(135deg, #34D399, #059669);
            transition: width 0.5s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .stat-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body>

<!-- 게임 화면 -->
<div id="gameScreen" class="screen active">
    <div class="min-h-screen bg-gray-100">
        <!-- 상단 헤더 -->
        <div class="bg-white shadow-sm p-4">
            <div class="flex items-center justify-between max-w-md mx-auto">
                <button onclick="goToMainPage()" class="text-gray-600">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-xl font-bold">게임</h1>
                <button onclick="refreshGames()" class="text-green-500">
                    <i class="fas fa-sync-alt text-xl"></i>
                </button>
            </div>
        </div>

        <div class="max-w-md mx-auto px-4 py-6">
            
            <!-- 경제 퀴즈 -->
            <div class="game-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-brain text-3xl text-purple-500"></i>
                        <div>
                            <h3 class="text-lg font-bold">경제 퀴즈</h3>
                            <p class="text-sm text-gray-500">경제 지식을 테스트해보세요</p>
                        </div>
                    </div>
                    <div class="ranking-badge">
                        <i class="fas fa-crown"></i>
                        1등: 김경제
                    </div>
                </div>
                
                <div id="quizContainer">
                    <div class="text-center py-6">
                        <i class="fas fa-play-circle text-4xl text-purple-500 mb-4"></i>
                        <p class="text-gray-600 mb-4">AI가 생성하는 다양한 경제 문제를 풀어보세요!</p>
                        <button onclick="startEconomicQuiz()" class="game-button">
                            <i class="fas fa-play mr-2"></i>퀴즈 시작
                        </button>
                    </div>
                </div>
            </div>

            <!-- 로켓빵야 -->
            <div class="game-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-rocket text-3xl text-red-500"></i>
                        <div>
                            <h3 class="text-lg font-bold">로켓빵야</h3>
                            <p class="text-sm text-gray-500">터치로 우주선을 조작하세요</p>
                        </div>
                    </div>
                    <div class="ranking-badge">
                        <i class="fas fa-crown"></i>
                        1등: 박투자
                    </div>
                </div>
                
                <div id="rocketGameContainer">
                    <canvas id="rocketCanvas" class="game-canvas" width="320" height="400"></canvas>
                    <div class="text-center">
                        <p class="text-sm text-gray-600 mb-2">점수: <span id="rocketScore">0</span></p>
                        <button onclick="startRocketGame()" id="rocketStartBtn" class="game-button">
                            <i class="fas fa-play mr-2"></i>게임 시작
                        </button>
                        <button onclick="pauseRocketGame()" id="rocketPauseBtn" class="game-button" style="display: none;">
                            <i class="fas fa-pause mr-2"></i>일시정지
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 text-center mt-2">
                        화면을 터치하여 로켓을 좌우로 움직이세요
                    </div>
                </div>
            </div>

            <!-- 똑부리 키우기 -->
            <div class="game-card mb-24">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-seedling text-3xl text-green-500"></i>
                        <div>
                            <h3 class="text-lg font-bold">똑부리 키우기</h3>
                            <p class="text-sm text-gray-500">경제 지식으로 똑부리를 키워보세요</p>
                        </div>
                    </div>
                    <div class="ranking-badge">
                        <i class="fas fa-crown"></i>
                        1등: 이금융
                    </div>
                </div>
                
                <div id="owlGameContainer" class="text-center">
                    <div class="character-container" onclick="petOwl()">
                        <div class="character-sprite" id="characterSprite">
                            🦉
                        </div>
                        <div class="character-effects" id="characterEffects"></div>
                    </div>
                    
                    <div class="mt-4">
                        <h4 class="font-bold text-lg" id="owlName">똑부리</h4>
                        <p class="text-sm text-gray-600" id="owlLevel">레벨 1 - 초보 투자자</p>
                    </div>
                    
                    <div class="exp-bar">
                        <div class="exp-fill" id="owlExpBar" style="width: 30%;"></div>
                    </div>
                    <p class="text-xs text-gray-500" id="owlExp">경험치: 300 / 1000</p>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="text-lg font-bold text-blue-600" id="owlKnowledge">85</div>
                            <div class="text-xs text-gray-600">경제 지식</div>
                        </div>
                        <div class="stat-item">
                            <div class="text-lg font-bold text-green-600" id="owlInvestment">42</div>
                            <div class="text-xs text-gray-600">투자 실력</div>
                        </div>
                        <div class="stat-item">
                            <div class="text-lg font-bold text-purple-600" id="owlHappiness">78</div>
                            <div class="text-xs text-gray-600">행복도</div>
                        </div>
                        <div class="stat-item">
                            <div class="text-lg font-bold text-orange-600" id="owlMoney">1,250</div>
                            <div class="text-xs text-gray-600">보유 코인</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 space-x-2">
                        <button onclick="feedOwl()" class="game-button">
                            <i class="fas fa-hamburger mr-2"></i>먹이주기
                        </button>
                        <button onclick="studyWithOwl()" class="game-button">
                            <i class="fas fa-book mr-2"></i>공부하기
                        </button>
                        <button onclick="investWithOwl()" class="game-button">
                            <i class="fas fa-chart-line mr-2"></i>투자하기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 하단 네비게이션 -->
        <div class="bottom-navigation">
            <div class="nav-container">
                <button onclick="navigateToPage('index.html')" class="nav-item">
                    <i class="fas fa-home text-gray-400"></i>
                    <span class="text-gray-400">홈</span>
                </button>
                <button onclick="navigateToPage('a2.html')" class="nav-item">
                    <i class="fas fa-newspaper text-gray-400"></i>
                    <span class="text-gray-400">뉴스</span>
                </button>
                <div class="nav-center">
                    <div id="navLevelBadge" class="level-badge-nav level-yellow" onclick="navigateToPage('a5.html')">
                        YELLOW
                    </div>
                </div>
                <button onclick="navigateToPage('a4.html')" class="nav-item active">
                    <i class="fas fa-gamepad"></i>
                    <span>게임</span>
                </button>
                <button onclick="navigateToPage('a3.html')" class="nav-item">
                    <i class="fas fa-ellipsis-h text-gray-400"></i>
                    <span class="text-gray-400">더보기</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 전역 게임 변수들
var currentUser = null;
var quizQuestions = [];
var currentQuizIndex = 0;
var quizScore = 0;

// 레벨 시스템 설정
var levelSystem = {
    yellow: { name: 'YELLOW', exp: 0, max: 3000, class: 'level-yellow' },
    orange: { name: 'ORANGE', exp: 3000, max: 6000, class: 'level-orange' },
    green: { name: 'GREEN', exp: 6000, max: 10000, class: 'level-green' },
    blue: { name: 'BLUE', exp: 10000, max: 15000, class: 'level-blue' },
    brown: { name: 'BROWN', exp: 15000, max: 25000, class: 'level-brown' },
    black: { name: 'BLACK', exp: 25000, max: 50000, class: 'level-black' },
    blackplus: { name: 'BLACK+', exp: 25000, max: 50000, class: 'level-black' },
    red: { name: 'RED', exp: 50000, max: 100000, class: 'level-red' }
};

// 로켓 게임 변수들
var rocketGame = {
    canvas: null,
    ctx: null,
    rocket: { x: 160, y: 350, width: 40, height: 60 },
    enemies: [],
    bullets: [],
    score: 0,
    gameLoop: null,
    isRunning: false,
    keys: {}
};

// 똑부리 게임 변수들
var owlData = JSON.parse(localStorage.getItem('owlData')) || {
    name: '똑부리',
    level: 1,
    exp: 300,
    maxExp: 1000,
    knowledge: 85,
    investment: 42,
    happiness: 78,
    money: 1250
};

// 페이지 이동 함수들 (캐시 무력화 적용)
function navigateToPage(page) {
    try {
        // 현재 시간을 이용한 캐시 버스터
        var cacheBuster = '?v=' + new Date().getTime();
        var currentHost = window.location.origin;
        var targetUrl = currentHost + '/' + page + cacheBuster;
        
        // 게임 데이터 저장
        saveOwlData();
        
        // 페이지 이동
        window.location.href = targetUrl;
    } catch (error) {
        console.error('페이지 이동 오류:', error);
        // 오류 시 기본 이동
        window.location.href = page;
    }
}

function goToMainPage() {
    navigateToPage('index.html');
}

function goToNewsPage() {
    navigateToPage('a2.html');
}

function goToGradePage() {
    navigateToPage('a5.html');
}

function goToGamePage() {
    navigateToPage('a4.html');
}

function goToMorePage() {
    navigateToPage('a3.html');
}

// 경제 퀴즈 시작
function startEconomicQuiz() {
    generateQuizQuestions();
    currentQuizIndex = 0;
    quizScore = 0;
    showQuizQuestion();
}

// 퀴즈 문제 생성
function generateQuizQuestions() {
    quizQuestions = [
        {
            question: "GDP는 무엇의 줄임말인가요?",
            options: ["Gross Domestic Product", "Global Development Program", "General Data Processing", "Great Digital Platform"],
            correct: 0,
            explanation: "GDP는 Gross Domestic Product(국내총생산)의 줄임말로, 한 나라의 경제 규모를 나타내는 지표입니다."
        },
        {
            question: "중앙은행의 기준금리 인상 효과는?",
            options: ["경기 부양", "인플레이션 억제", "수출 증가", "실업률 감소"],
            correct: 1,
            explanation: "기준금리 인상은 시중의 돈의 양을 줄여 인플레이션을 억제하는 효과가 있습니다."
        },
        {
            question: "주식의 PER이 높다는 것은?",
            options: ["저평가", "고평가", "적정가치", "위험 낮음"],
            correct: 1,
            explanation: "PER이 높다는 것은 주가가 수익에 비해 높게 평가되고 있다는 의미입니다."
        },
        {
            question: "분산투자의 목적은?",
            options: ["수익 극대화", "위험 감소", "거래비용 절약", "세금 절약"],
            correct: 1,
            explanation: "분산투자는 여러 자산에 투자하여 위험을 분산시키는 것이 주목적입니다."
        },
        {
            question: "인플레이션의 원인이 아닌 것은?",
            options: ["통화량 증가", "수요 증가", "공급 감소", "저축 증가"],
            correct: 3,
            explanation: "저축 증가는 소비 감소를 의미하므로 인플레이션과는 반대 효과를 가져옵니다."
        }
    ];
    
    // 문제 순서 랜덤화
    quizQuestions.sort(() => Math.random() - 0.5);
}

// 퀴즈 문제 표시
function showQuizQuestion() {
    if (currentQuizIndex >= quizQuestions.length) {
        showQuizResult();
        return;
    }
    
    var question = quizQuestions[currentQuizIndex];
    var html = '<div class="mb-6">';
    html += '<h4 class="text-lg font-bold mb-4">문제 ' + (currentQuizIndex + 1) + '/' + quizQuestions.length + '</h4>';
    html += '<p class="text-gray-700 mb-4">' + question.question + '</p>';
    
    question.options.forEach(function(option, index) {
        html += '<div class="bg-gray-50 p-3 rounded-lg mb-2 cursor-pointer hover:bg-blue-50 transition-colors" onclick="selectAnswer(' + index + ')">';
        html += '<span>' + (index + 1) + '. ' + option + '</span>';
        html += '</div>';
    });
    
    html += '</div>';
    document.getElementById('quizContainer').innerHTML = html;
}

// 퀴즈 답 선택
function selectAnswer(selectedIndex) {
    var question = quizQuestions[currentQuizIndex];
    var isCorrect = selectedIndex === question.correct;
    
    if (isCorrect) {
        quizScore++;
        gainOwlExp(50);
    }
    
    // 정답 표시
    var options = document.querySelectorAll('#quizContainer .bg-gray-50');
    options.forEach(function(option, index) {
        option.onclick = null;
        if (index === question.correct) {
            option.classList.add('bg-green-100', 'border-green-500');
            option.classList.remove('bg-gray-50');
        } else if (index === selectedIndex && !isCorrect) {
            option.classList.add('bg-red-100', 'border-red-500');
            option.classList.remove('bg-gray-50');
        }
    });
    
    // 설명 표시
    setTimeout(function() {
        var explanation = document.createElement('div');
        explanation.className = 'mt-4 p-4 bg-blue-50 rounded-lg';
        explanation.innerHTML = '<p class="text-sm text-blue-800"><strong>해설:</strong> ' + question.explanation + '</p>';
        document.getElementById('quizContainer').appendChild(explanation);
        
        var nextBtn = document.createElement('button');
        nextBtn.className = 'game-button mt-4';
        nextBtn.textContent = currentQuizIndex < quizQuestions.length - 1 ? '다음 문제' : '결과 보기';
        nextBtn.onclick = function() {
            currentQuizIndex++;
            showQuizQuestion();
        };
        document.getElementById('quizContainer').appendChild(nextBtn);
    }, 1500);
}

// 퀴즈 결과 표시
function showQuizResult() {
    var percentage = Math.round((quizScore / quizQuestions.length) * 100);
    var expGained = quizScore * 100;
    
    var html = '<div class="text-center py-6">';
    html += '<i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>';
    html += '<h3 class="text-2xl font-bold mb-4">퀴즈 완료!</h3>';
    html += '<p class="text-lg mb-2">점수: ' + quizScore + '/' + quizQuestions.length + ' (' + percentage + '%)</p>';
    html += '<p class="text-green-600 font-semibold mb-4">획득 EXP: +' + expGained + '</p>';
    
    if (percentage >= 80) {
        html += '<p class="text-blue-600 mb-4">🎉 훌륭합니다!</p>';
    } else if (percentage >= 60) {
        html += '<p class="text-green-600 mb-4">👍 좋은 성과입니다!</p>';
    } else {
        html += '<p class="text-orange-600 mb-4">💪 더 열심히 공부해보세요!</p>';
    }
    
    html += '<button onclick="startEconomicQuiz()" class="game-button mr-2">다시 도전</button>';
    html += '<button onclick="location.reload()" class="game-button">메인으로</button>';
    html += '</div>';
    
    document.getElementById('quizContainer').innerHTML = html;
    gainOwlExp(expGained);
}

// 로켓 게임 시작
function startRocketGame() {
    rocketGame.canvas = document.getElementById('rocketCanvas');
    rocketGame.ctx = rocketGame.canvas.getContext('2d');
    
    // 터치 이벤트 추가
    rocketGame.canvas.addEventListener('touchstart', handleTouch, { passive: false });
    rocketGame.canvas.addEventListener('touchmove', handleTouch, { passive: false });
    
    // 클릭 이벤트 추가
    rocketGame.canvas.addEventListener('click', handleClick);
    
    resetRocketGame();
    rocketGame.isRunning = true;
    document.getElementById('rocketStartBtn').style.display = 'none';
    document.getElementById('rocketPauseBtn').style.display = 'inline-block';
    
    rocketGame.gameLoop = setInterval(updateRocketGame, 16);
}

// 터치 이벤트 처리
function handleTouch(e) {
    e.preventDefault();
    var rect = rocketGame.canvas.getBoundingClientRect();
    var touch = e.touches[0] || e.changedTouches[0];
    var x = touch.clientX - rect.left;
    
    // 로켓을 터치 위치로 이동
    rocketGame.rocket.x = Math.max(0, Math.min(x - rocketGame.rocket.width / 2, rocketGame.canvas.width - rocketGame.rocket.width));
}

// 클릭 이벤트 처리
function handleClick(e) {
    var rect = rocketGame.canvas.getBoundingClientRect();
    var x = e.clientX - rect.left;
    
    // 로켓을 클릭 위치로 이동
    rocketGame.rocket.x = Math.max(0, Math.min(x - rocketGame.rocket.width / 2, rocketGame.canvas.width - rocketGame.rocket.width));
}

// 로켓 게임 초기화
function resetRocketGame() {
    rocketGame.rocket.x = 160;
    rocketGame.rocket.y = 350;
    rocketGame.enemies = [];
    rocketGame.bullets = [];
    rocketGame.score = 0;
    updateRocketScore();
}

// 로켓 게임 업데이트
function updateRocketGame() {
    if (!rocketGame.isRunning) return;
    
    var ctx = rocketGame.ctx;
    var canvas = rocketGame.canvas;
    
    // 화면 클리어
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 적 생성
    if (Math.random() < 0.02) {
        rocketGame.enemies.push({
            x: Math.random() * (canvas.width - 30),
            y: -30,
            type: Math.random() > 0.5 ? 'good' : 'bad'
        });
    }
    
    // 총알 자동 발사
    if (Math.random() < 0.1) {
        rocketGame.bullets.push({
            x: rocketGame.rocket.x + rocketGame.rocket.width / 2 - 2,
            y: rocketGame.rocket.y
        });
    }
    
    // 로켓 그리기
    ctx.fillStyle = '#EF4444';
    ctx.beginPath();
    ctx.moveTo(rocketGame.rocket.x + rocketGame.rocket.width / 2, rocketGame.rocket.y);
    ctx.lineTo(rocketGame.rocket.x, rocketGame.rocket.y + rocketGame.rocket.height);
    ctx.lineTo(rocketGame.rocket.x + rocketGame.rocket.width, rocketGame.rocket.y + rocketGame.rocket.height);
    ctx.closePath();
    ctx.fill();
    
    // 적들 업데이트 및 그리기
    rocketGame.enemies = rocketGame.enemies.filter(function(enemy) {
        enemy.y += 2;
        
        // 적 그리기
        ctx.fillStyle = enemy.type === 'good' ? '#10B981' : '#EF4444';
        ctx.beginPath();
        ctx.arc(enemy.x + 15, enemy.y + 15, 15, 0, 2 * Math.PI);
        ctx.fill();
        
        // 적이 화면 하단에 도달하면 제거
        if (enemy.y > canvas.height) {
            return false;
        }
        
        // 로켓과 충돌 체크
        if (enemy.x < rocketGame.rocket.x + rocketGame.rocket.width &&
            enemy.x + 30 > rocketGame.rocket.x &&
            enemy.y < rocketGame.rocket.y + rocketGame.rocket.height &&
            enemy.y + 30 > rocketGame.rocket.y) {
            
            if (enemy.type === 'good') {
                rocketGame.score += 100;
                updateRocketScore();
            } else {
                gameOver();
            }
            return false;
        }
        
        return true;
    });
    
    // 총알들 업데이트 및 그리기
    rocketGame.bullets = rocketGame.bullets.filter(function(bullet) {
        bullet.y -= 5;
        
        // 총알 그리기
        ctx.fillStyle = '#FCD34D';
        ctx.fillRect(bullet.x, bullet.y, 4, 12);
        
        // 화면 밖으로 나가면 제거
        if (bullet.y < 0) return false;
        
        // 적과 충돌 체크
        var hit = false;
        rocketGame.enemies = rocketGame.enemies.filter(function(enemy) {
            if (bullet.x < enemy.x + 30 &&
                bullet.x + 4 > enemy.x &&
                bullet.y < enemy.y + 30 &&
                bullet.y + 12 > enemy.y) {
                
                if (enemy.type === 'good') {
                    rocketGame.score += 50;
                } else {
                    rocketGame.score += 100;
                }
                updateRocketScore();
                hit = true;
                return false;
            }
            return true;
        });
        
        return !hit;
    });
}

// 로켓 게임 점수 업데이트
function updateRocketScore() {
    document.getElementById('rocketScore').textContent = rocketGame.score;
}

// 로켓 게임 일시정지
function pauseRocketGame() {
    rocketGame.isRunning = false;
    clearInterval(rocketGame.gameLoop);
    document.getElementById('rocketStartBtn').style.display = 'inline-block';
    document.getElementById('rocketPauseBtn').style.display = 'none';
}

// 게임 오버
function gameOver() {
    pauseRocketGame();
    gainOwlExp(Math.floor(rocketGame.score / 10));
    alert('게임 오버! 점수: ' + rocketGame.score + '\n경험치 +' + Math.floor(rocketGame.score / 10));
}

// 똑부리 쓰다듬기
function petOwl() {
    owlData.happiness = Math.min(100, owlData.happiness + 5);
    gainOwlExp(10);
    updateOwlDisplay();
    
    // 향상된 애니메이션 효과
    var sprite = document.getElementById('characterSprite');
    var effects = document.getElementById('characterEffects');
    
    // 캐릭터 애니메이션
    sprite.classList.add('happy');
    setTimeout(function() {
        sprite.classList.remove('happy');
    }, 600);
    
    // 하트 이펙트
    createFloatingEffect('💖', effects);
    
    showEnhancedMessage('똑부리가 좋아합니다! 행복도 +5, 경험치 +10', 'success');
}

// 똑부리 먹이주기
function feedOwl() {
    if (owlData.money >= 50) {
        owlData.money -= 50;
        owlData.happiness = Math.min(100, owlData.happiness + 15);
        gainOwlExp(30);
        updateOwlDisplay();
        
        // 먹이 이펙트
        var effects = document.getElementById('characterEffects');
        createFloatingEffect('🍎', effects);
        
        showEnhancedMessage('똑부리에게 먹이를 줬습니다! 행복도 +15, 경험치 +30', 'success');
    } else {
        showEnhancedMessage('코인이 부족합니다! (필요: 50코인)', 'error');
    }
}

// 똑부리와 공부하기
function studyWithOwl() {
    if (owlData.money >= 100) {
        owlData.money -= 100;
        owlData.knowledge = Math.min(100, owlData.knowledge + 8);
        gainOwlExp(80);
        updateOwlDisplay();
        
        // 공부 이펙트
        var effects = document.getElementById('characterEffects');
        createFloatingEffect('📚', effects);
        
        showEnhancedMessage('똑부리와 함께 공부했습니다! 경제 지식 +8, 경험치 +80', 'success');
    } else {
        showEnhancedMessage('코인이 부족합니다! (필요: 100코인)', 'error');
    }
}

// 똑부리와 투자하기
function investWithOwl() {
    if (owlData.money >= 200) {
        var success = Math.random() > 0.3; // 70% 성공률
        owlData.money -= 200;
        
        var effects = document.getElementById('characterEffects');
        
        if (success) {
            var profit = Math.floor(Math.random() * 300) + 100;
            owlData.money += profit;
            owlData.investment = Math.min(100, owlData.investment + 5);
            gainOwlExp(100);
            
            // 성공 이펙트
            createFloatingEffect('💰', effects);
            
            showEnhancedMessage('투자 성공! +' + profit + '코인, 투자 실력 +5, 경험치 +100', 'success');
        } else {
            owlData.investment = Math.min(100, owlData.investment + 2);
            gainOwlExp(50);
            
            // 실패 이펙트
            createFloatingEffect('📉', effects);
            
            showEnhancedMessage('투자 실패... 하지만 경험은 쌓였습니다! 투자 실력 +2, 경험치 +50', 'warning');
        }
        updateOwlDisplay();
    } else {
        showEnhancedMessage('코인이 부족합니다! (필요: 200코인)', 'error');
    }
}

// 플로팅 이펙트 생성
function createFloatingEffect(emoji, container) {
    var effect = document.createElement('div');
    effect.className = 'floating-heart';
    effect.textContent = emoji;
    effect.style.left = Math.random() * 60 + 'px';
    effect.style.top = Math.random() * 60 + 'px';
    
    container.appendChild(effect);
    
    setTimeout(function() {
        container.removeChild(effect);
    }, 1000);
}

// 향상된 메시지 표시
function showEnhancedMessage(message, type) {
    var colors = {
        success: '#10B981',
        warning: '#F59E0B',
        error: '#EF4444',
        info: '#3B82F6'
    };
    
    var messageDiv = document.createElement('div');
    messageDiv.style.cssText = 
        'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); ' +
        'background: ' + (colors[type] || colors.info) + '; color: white; ' +
        'padding: 12px 24px; border-radius: 8px; font-weight: bold; z-index: 1000; ' +
        'box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideDown 0.3s ease-out;';
    
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    setTimeout(function() {
        document.body.removeChild(messageDiv);
    }, 3000);
}

// 똑부리 경험치 획득
function gainOwlExp(amount) {
    owlData.exp += amount;
    
    // 경험치 플로팅 이펙트
    var effects = document.getElementById('characterEffects');
    var expEffect = document.createElement('div');
    expEffect.className = 'floating-exp';
    expEffect.textContent = '+' + amount + ' EXP';
    expEffect.style.left = '50px';
    expEffect.style.top = '20px';
    effects.appendChild(expEffect);
    
    setTimeout(function() {
        effects.removeChild(expEffect);
    }, 1000);
    
    // 레벨업 체크
    if (owlData.exp >= owlData.maxExp) {
        levelUpOwl();
    }
    
    updateOwlDisplay();
    saveOwlData();
    
    // 메인 사용자 데이터에도 경험치 추가
    syncWithMainUser(amount);
}

// 레벨업 처리
function levelUpOwl() {
    owlData.level++;
    owlData.exp = 0;
    owlData.maxExp = owlData.level * 1000;
    owlData.money += owlData.level * 100;
    
    var levelNames = ['초보 투자자', '견습 투자자', '숙련 투자자', '전문 투자자', '투자 마스터', '투자 전설', '투자 신'];
    var levelName = levelNames[Math.min(owlData.level - 1, levelNames.length - 1)];
    
    // 레벨업 애니메이션
    var sprite = document.getElementById('characterSprite');
    sprite.classList.add('level-up');
    setTimeout(function() {
        sprite.classList.remove('level-up');
    }, 1000);
    
    // 레벨업 이펙트
    var effects = document.getElementById('characterEffects');
    createFloatingEffect('🎉', effects);
    createFloatingEffect('✨', effects);
    createFloatingEffect('🌟', effects);
    
    showEnhancedMessage('🎉 레벨업! 레벨 ' + owlData.level + ' - ' + levelName + '\n보너스 코인 +' + (owlData.level * 100), 'success');
}

// 메인 사용자 데이터와 동기화
function syncWithMainUser(expAmount) {
    try {
        var mainUserData = localStorage.getItem('fineu_current_user');
        if (mainUserData) {
            var userData = JSON.parse(mainUserData);
            userData.exp = (userData.exp || 0) + Math.floor(expAmount / 2); // 게임에서는 절반의 경험치
            
            localStorage.setItem('fineu_current_user', JSON.stringify(userData));
            localStorage.setItem('user_' + userData.id, JSON.stringify(userData));
        }
    } catch (error) {
        console.error('사용자 데이터 동기화 오류:', error);
    }
}

// 사용자 데이터 로드
function loadUserData() {
    try {
        var userData = localStorage.getItem('fineu_current_user');
        if (userData) {
            currentUser = JSON.parse(userData);
            updateLevelBadge();
        }
    } catch (error) {
        console.error('사용자 데이터 로드 오류:', error);
    }
}

// 레벨 뱃지 업데이트
function updateLevelBadge() {
    var levelBadge = document.getElementById('navLevelBadge');
    if (levelBadge && currentUser && levelSystem[currentUser.level]) {
        var levelInfo = levelSystem[currentUser.level];
        levelBadge.className = 'level-badge-nav ' + levelInfo.class;
        levelBadge.textContent = levelInfo.name;
    }
}

// 똑부리 정보 업데이트
function updateOwlDisplay() {
    document.getElementById('owlLevel').textContent = '레벨 ' + owlData.level + ' - ' + getLevelName();
    document.getElementById('owlExp').textContent = '경험치: ' + owlData.exp + ' / ' + owlData.maxExp;
    document.getElementById('owlExpBar').style.width = (owlData.exp / owlData.maxExp * 100) + '%';
    
    document.getElementById('owlKnowledge').textContent = owlData.knowledge;
    document.getElementById('owlInvestment').textContent = owlData.investment;
    document.getElementById('owlHappiness').textContent = owlData.happiness;
    document.getElementById('owlMoney').textContent = owlData.money.toLocaleString();
}

// 레벨 이름 가져오기
function getLevelName() {
    var levelNames = ['초보 투자자', '견습 투자자', '숙련 투자자', '전문 투자자', '투자 마스터', '투자 전설', '투자 신'];
    return levelNames[Math.min(owlData.level - 1, levelNames.length - 1)];
}

// 똑부리 데이터 저장
function saveOwlData() {
    localStorage.setItem('owlData', JSON.stringify(owlData));
}

// 게임 새로고침
function refreshGames() {
    location.reload();
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 사용자 데이터 로드
    loadUserData();
    
    // 똑부리 데이터 업데이트
    updateOwlDisplay();
    
    console.log('게임 페이지 초기화 완료');
});
</script>

</body>
</html>



